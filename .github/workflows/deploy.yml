name: Deploy to Micro.blog

on:
  push:
    branches:
      - main
    paths:
      - 'layouts/**'
      - 'static/**'
      - 'config.json'
      - 'data/**'
  workflow_dispatch:
    inputs:
      theme_id:
        description: 'Override theme ID (optional)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Start deployment
        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: production
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '.github/deploy/requirements.txt'
      
      - name: Install dependencies
        run: |
          cd .github/deploy
          pip install -r requirements.txt
      
      - name: Generate cache key date prefix
        id: cache-key
        run: |
          # Generate a date-based prefix for cache key (changes daily)
          DATE_PREFIX=$(date -u +%Y-%m-%d)
          echo "date_prefix=${DATE_PREFIX}" >> $GITHUB_OUTPUT
          echo "ðŸ“… Cache date prefix: ${DATE_PREFIX}"
      
      - name: Restore session cookie from cache
        id: cache-session
        uses: actions/cache@v4
        with:
          path: .session-cookie
          key: microblog-session-${{ github.repository }}-${{ steps.cache-key.outputs.date_prefix }}
          restore-keys: |
            microblog-session-${{ github.repository }}-
      
      - name: Authenticate to Micro.blog
        if: steps.cache-session.outputs.cache-hit != 'true'
        env:
          GMAIL_EMAIL: ${{ vars.GMAIL_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          MICROBLOG_EMAIL: ${{ vars.MICROBLOG_EMAIL }}
          MICROBLOG_SITE_ID: ${{ vars.MICROBLOG_SITE_ID }}
        run: |
          echo "ðŸ” No cached session found - authenticating..."
          python3 .github/deploy/microblog_auth.py --output .session-cookie
      
      - name: Validate session cookie
        env:
          MICROBLOG_THEME_ID: ${{ inputs.theme_id || vars.MICROBLOG_THEME_ID }}
        run: |
          echo "ðŸ” Validating session cookie..."
          python3 .github/deploy/microblog_deploy.py --validate-only
      
      - name: Deploy to Micro.blog
        env:
          MICROBLOG_THEME_ID: ${{ inputs.theme_id || vars.MICROBLOG_THEME_ID }}
        run: |
          echo "ðŸš€ Deploying to Micro.blog..."
          python3 .github/deploy/microblog_deploy.py --all
      
      - name: Create deployment summary
        if: always()
        run: |
          echo "## Micro.blog Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.cache-session.outputs.cache-hit }}" = "true" ]; then
            echo "- ðŸ” **Authentication:** Used cached session" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ” **Authentication:** Fresh login via email" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "- âœ… **Deployment Status:** Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Deployment Status:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- ðŸŽ¨ **Theme ID:** ${{ inputs.theme_id || vars.MICROBLOG_THEME_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ•’ **Completed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 HEAD | grep -E '(layouts/|static/|config\.json)' || echo "No template files changed"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Update deployment status
        uses: bobheadxi/deployments@v1
        if: always()
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
          env: ${{ steps.deployment.outputs.env }}
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env_url: https://waccamaw.micro.blog/
