{{ define "main" }}

{{ $allPosts := where .Site.RegularPages "Type" "post" }}

<!-- Featured Hero (1 post only) -->
{{ $featured := where .Site.RegularPages ".Params.categories" "intersect" (slice "featured") }}
{{ if $featured }}
	<div class="hero-carousel">
		{{ range first 1 $featured }}
			<article class="hero-slide">
				{{ if .Params.photos }}
					{{ $originalImage := index .Params.photos 0 }}
					{{ $heroImage := printf "https://micro.blog/photos/1800x/%s" $originalImage }}
					<div class="hero-background">
						<img src="{{ $heroImage }}" alt="{{ .Title }}" loading="eager">
						<div class="hero-overlay"></div>
					</div>
				{{ end }}
				<div class="hero-content">
					<div class="hero-text">
						<span class="hero-label">Featured</span>
						<h1 class="hero-title">{{ .Title }}</h1>
					<div class="hero-meta">
						<time datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "January 2, 2006" }}
						</time>
						{{ with .Params.author }}
							{{ if reflect.IsMap . }}
								<span class="hero-author">
									{{ with .avatar }}<img src="{{ . }}" alt="{{ $.Params.author.full_name }}" class="author-avatar"> {{ end }}
									{{ .full_name | default .name }}
								</span>
							{{ else }}
								<span class="hero-author">{{ . }}</span>
							{{ end }}
						{{ end }}
					</div>
						<p class="hero-excerpt">{{ .Summary }}</p>
						<a href="{{ .Permalink }}" class="hero-cta">Read Full Story</a>
					</div>
				</div>
			</article>
		{{ end }}
	</div>
{{ end }}

<!-- Last 3 Blog Posts -->
<div class="recent-updates">
	<div class="updates-list">
	{{ range $index, $post := first 3 $allPosts }}
		<article class="update-item h-entry">
			{{ if $post.Params.photos }}
				{{ $originalImage := index $post.Params.photos 0 }}
				{{ $resizedImage := printf "https://micro.blog/photos/900x/%s" $originalImage }}
				<div class="update-image auto-layout-image" data-index="{{ $index }}" onclick="openLightbox('{{ $originalImage }}')">
					<img src="{{ $resizedImage }}" alt="{{ $post.Title }}" loading="lazy" data-src="{{ $originalImage }}">
				</div>
			{{ end }}
			<div class="update-content">
				<h3 class="p-name update-title">
					<a href="{{ $post.Permalink }}">{{ $post.Title }}</a>
				</h3>
				<div class="update-meta">
					<time class="dt-published" datetime="{{ $post.Date.Format "2006-01-02T15:04:05-0700" }}">
						{{ $post.Date.Format "January 2, 2006" }}
					</time>
					{{ if $post.Params.categories }}
						<span class="update-categories">
							{{ range $post.Params.categories }}
								<span class="category-badge">{{ . }}</span>
							{{ end }}
						</span>
					{{ end }}
				</div>
				<p class="update-excerpt">{{ $post.Summary | truncate 200 }}</p>
				<a href="{{ $post.Permalink }}" class="u-url update-link">Read more â†’</a>
				</div>
			</article>
		{{ end }}
	</div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
	<span class="lightbox-close">Ã—</span>
	<img id="lightbox-img" src="" alt="">
</div>

<script>
function openLightbox(src) {
	event.stopPropagation();
	document.getElementById('lightbox').classList.add('active');
	document.getElementById('lightbox-img').src = src;
	document.body.style.overflow = 'hidden';
}

function closeLightbox() {
	document.getElementById('lightbox').classList.remove('active');
	document.body.style.overflow = 'auto';
}

document.addEventListener('keydown', function(e) {
	if (e.key === 'Escape') {
		closeLightbox();
	}
});

// Auto-layout images based on aspect ratio
function autoLayoutImage(img) {
	if (img.naturalWidth && img.naturalHeight) {
		const aspectRatio = img.naturalWidth / img.naturalHeight;
		const container = img.closest('.auto-layout-image');
		
		if (!container) return;
		
		// If image is square or portrait (aspect ratio <= 1.2), float it right
		if (aspectRatio <= 1.2) {
			container.classList.add('floated-right');
		}
	}
}

document.addEventListener('DOMContentLoaded', function() {
	const images = document.querySelectorAll('.auto-layout-image img');
	images.forEach(img => {
		if (img.complete && img.naturalHeight !== 0) {
			autoLayoutImage(img);
		} else {
			img.addEventListener('load', function() {
				autoLayoutImage(img);
			});
		}
	});
});
</script>

<!-- Recent Updates Grid (all content) -->
<div class="homepage-sections">
	<div class="other-posts-section">
		<div class="posts-grid">
			{{ range $index, $post := after 3 (first 18 $allPosts) }}
				{{ $colorIndex := mod $index 6 }}
				<article class="post-card h-entry">
					{{ if .Params.photos }}
						{{ $originalImage := index .Params.photos 0 }}
						{{ $resizedImage := printf "https://micro.blog/photos/400x/%s" $originalImage }}
						<div class="post-card-image">
							<a href="{{ .Permalink }}">
								<img src="{{ $resizedImage }}" alt="{{ .Title }}" loading="lazy">
							</a>
						</div>
					{{ else }}
						<div class="post-card-placeholder post-card-color-{{ $colorIndex }}">
							<a href="{{ .Permalink }}">
								<span class="placeholder-icon">ðŸ“„</span>
							</a>
						</div>
					{{ end }}
					<div class="post-card-content">
						<h3 class="p-name post-card-title">
							<a href="{{ .Permalink }}">{{ .Title }}</a>
						</h3>
						<time class="dt-published post-card-date" datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "Jan 2, 2006" }}
						</time>
					</div>
				</article>
			{{ end }}
		</div>
		<a href="/updates/" class="view-all-link">View all updates â†’</a>
	</div>

	<!-- Most Recent Meeting -->
	<div class="recent-meeting-section">
		{{ $meetings := where $allPosts ".Params.categories" "intersect" (slice "meetings") }}
		{{ with index $meetings 0 }}
			<a href="{{ .Permalink }}" class="meeting-item-home">
				<div class="meeting-calendar">
					<div class="calendar-month">{{ .Date.Format "Jan" }}</div>
					{{ if in .Title "Open Meeting" }}
						<div class="calendar-label">Open<br>Meeting</div>
					{{ else if in .Title "Executive" }}
						<div class="calendar-label">Executive</div>
					{{ else }}
						<div class="calendar-label">Meeting</div>
					{{ end }}
				</div>
				<div class="meeting-info">
					<h3 class="meeting-title">{{ .Title }}</h3>
					<div class="meeting-meta">
						<time datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "January 2, 2006" }}
						</time>
					</div>
					{{ if .Summary }}
						<p class="meeting-summary">{{ .Summary | truncate 300 }}</p>
					{{ end }}
				</div>
			</a>
		{{ end }}
		<a href="/categories/meetings/" class="view-all-link">View all meetings â†’</a>
	</div>
</div>

{{ end }}
