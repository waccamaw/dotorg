{{ define "main" }}

{{ $allPosts := where .Site.RegularPages "Type" "post" }}

<!-- Featured Hero (1 post only) -->
{{ $featured := where .Site.RegularPages ".Params.categories" "intersect" (slice "featured") }}
{{ if $featured }}
	<div class="hero-carousel">
		{{ range first 1 $featured }}
			<article class="hero-slide">
				{{ if .Params.photos }}
					{{ $originalImage := index .Params.photos 0 }}
					{{ $heroImage := printf "https://micro.blog/photos/1800x/%s" $originalImage }}
					<div class="hero-background">
						<img src="{{ $heroImage }}" alt="{{ .Title }}" loading="eager">
						<div class="hero-overlay"></div>
					</div>
				{{ end }}
				<div class="hero-content">
					<div class="hero-text">
						<span class="hero-label">Featured</span>
						<h1 class="hero-title">{{ .Title }}</h1>
					<div class="hero-meta">
						<time datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "January 2, 2006" }}
						</time>
						{{ with .Params.author }}
							{{ if reflect.IsMap . }}
								<span class="hero-author">
									{{ with .avatar }}<img src="{{ . }}" alt="{{ $.Params.author.full_name }}" class="author-avatar"> {{ end }}
									{{ .full_name | default .name }}
								</span>
							{{ else }}
								<span class="hero-author">{{ . }}</span>
							{{ end }}
						{{ end }}
					</div>
						{{ if .Content }}
							<p class="hero-excerpt">{{ .Content | plainify | htmlUnescape | truncate 250 }}</p>
						{{ end }}
						<a href="{{ .Permalink }}" class="hero-cta">Read Full Story</a>
					</div>
				</div>
			</article>
		{{ end }}
	</div>
{{ end }}

<!-- Last 3 Blog Posts -->
<div class="recent-updates">
	<div class="updates-list">
	{{ range $index, $post := first 3 $allPosts }}
		<article class="update-item h-entry">
			{{ if $post.Params.photos }}
				{{ $originalImage := index $post.Params.photos 0 }}
				{{ $resizedImage := printf "https://micro.blog/photos/900x/%s" $originalImage }}
				<div class="update-image auto-layout-image" data-index="{{ $index }}" onclick="openLightbox('{{ $originalImage }}')">
					<img src="{{ $resizedImage }}" alt="{{ $post.Title }}" loading="lazy" data-src="{{ $originalImage }}">
				</div>
			{{ end }}
			<div class="update-content">
				<h3 class="p-name update-title">
					<a href="{{ $post.Permalink }}">{{ $post.Title }}</a>
				</h3>
				<div class="update-meta">
					<time class="dt-published" datetime="{{ $post.Date.Format "2006-01-02T15:04:05-0700" }}">
						{{ $post.Date.Format "January 2, 2006" }}
					</time>
					{{ if $post.Params.categories }}
						<span class="update-categories">
							{{ range $post.Params.categories }}
								<span class="category-badge">{{ . }}</span>
							{{ end }}
						</span>
					{{ end }}
				</div>
				{{ if $post.Content }}
					<p class="update-excerpt">{{ $post.Content | plainify | htmlUnescape | truncate 200 }}</p>
				{{ end }}
				<a href="{{ $post.Permalink }}" class="u-url update-link">Read more ‚Üí</a>
				</div>
			</article>
		{{ end }}
	</div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
	<span class="lightbox-close">√ó</span>
	<img id="lightbox-img" src="" alt="">
</div>

<script>
function openLightbox(src) {
	event.stopPropagation();
	document.getElementById('lightbox').classList.add('active');
	document.getElementById('lightbox-img').src = src;
	document.body.style.overflow = 'hidden';
}

function closeLightbox() {
	document.getElementById('lightbox').classList.remove('active');
	document.body.style.overflow = 'auto';
}

document.addEventListener('keydown', function(e) {
	if (e.key === 'Escape') {
		closeLightbox();
	}
});

// Auto-layout images based on aspect ratio
function autoLayoutImage(img) {
	if (img.naturalWidth && img.naturalHeight) {
		const aspectRatio = img.naturalWidth / img.naturalHeight;
		const container = img.closest('.auto-layout-image');
		
		if (!container) return;
		
		// If image is square or portrait (aspect ratio <= 1.2), float it right
		if (aspectRatio <= 1.2) {
			container.classList.add('floated-right');
		}
	}
}

document.addEventListener('DOMContentLoaded', function() {
	const images = document.querySelectorAll('.auto-layout-image img');
	images.forEach(img => {
		if (img.complete && img.naturalHeight !== 0) {
			autoLayoutImage(img);
		} else {
			img.addEventListener('load', function() {
				autoLayoutImage(img);
			});
		}
	});
});
</script>

<!-- Recent Updates Grid (all content) -->
<div class="homepage-sections">
	<div class="other-posts-section">
		<div class="posts-grid">
			{{ range $index, $post := after 3 (first 18 $allPosts) }}
				{{ $colorIndex := mod $index 6 }}
				<article class="post-card h-entry">
					{{ if .Params.photos }}
						{{ $originalImage := index .Params.photos 0 }}
						{{ $resizedImage := printf "https://micro.blog/photos/400x/%s" $originalImage }}
						<div class="post-card-image">
							<a href="{{ .Permalink }}">
								<img src="{{ $resizedImage }}" alt="{{ .Title }}" loading="lazy">
							</a>
						</div>
					{{ else }}
						<div class="post-card-placeholder post-card-color-{{ $colorIndex }}">
							<a href="{{ .Permalink }}">
								<span class="placeholder-icon">üìÑ</span>
							</a>
						</div>
					{{ end }}
					<div class="post-card-content">
						<h3 class="p-name post-card-title">
							<a href="{{ .Permalink }}">{{ .Title }}</a>
						</h3>
						<time class="dt-published post-card-date" datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "Jan 2, 2006" }}
						</time>
					</div>
				</article>
			{{ end }}
		</div>
		<a href="/updates/" class="view-all-link">View all updates ‚Üí</a>
	</div>
</div>

<!-- Newsletter Signup -->
<div class="newsletter-signup">
	<div class="newsletter-content">
		<div class="newsletter-text">
			<h3>Stay Updated</h3>
			<p>Get Waccamaw news, event announcements, and cultural updates delivered to your inbox.</p>
		</div>
		<form class="newsletter-form" id="newsletterForm">
			<input 
				type="text" 
				name="name" 
				id="newsletter-name"
				placeholder="Your full name" 
				required
				aria-label="Full name for newsletter"
				style="display: none;"
			>
			<input 
				type="email" 
				name="email" 
				id="newsletter-email"
				placeholder="Your email address" 
				required
				aria-label="Email address for newsletter"
			>
			<button type="submit">Subscribe</button>
		</form>
	</div>
	<div id="newsletter-message" style="display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; text-align: center;"></div>
</div>

<script>
const newsletterForm = document.getElementById('newsletterForm');
const emailInput = document.getElementById('newsletter-email');
const nameInput = document.getElementById('newsletter-name');

// Show name field when email is focused
emailInput.addEventListener('focus', function() {
	if (nameInput.style.display === 'none') {
		nameInput.style.display = 'block';
		// Smooth scroll into view if needed
		setTimeout(() => {
			nameInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
		}, 100);
	}
});

newsletterForm.addEventListener('submit', async function(e) {
	e.preventDefault();
	
	const name = nameInput.value || 'Newsletter Subscriber';
	const email = emailInput.value;
	const submitButton = this.querySelector('button[type="submit"]');
	const messageDiv = document.getElementById('newsletter-message');
	
	// Disable button and show loading state
	submitButton.disabled = true;
	submitButton.textContent = 'Subscribing...';
	
	try {
		const response = await fetch('https://contact.waccamaw.org/api/contact', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				name: name,
				email: email,
				category: 'general',
				message: 'Newsletter subscription request',
				newsletter: true
			})
		});
		
		if (response.ok) {
			messageDiv.textContent = 'Thank you for subscribing! Please check your email to confirm your subscription.';
			messageDiv.style.display = 'block';
			messageDiv.style.backgroundColor = 'var(--success-bg, #d4edda)';
			messageDiv.style.color = 'var(--success-text, #155724)';
			this.reset();
		} else {
			throw new Error('Subscription failed');
		}
	} catch (error) {
		messageDiv.textContent = 'Sorry, there was an error. Please try again.';
		messageDiv.style.display = 'block';
		messageDiv.style.backgroundColor = 'var(--error-bg, #f8d7da)';
		messageDiv.style.color = 'var(--error-text, #721c24)';
	} finally {
		submitButton.disabled = false;
		submitButton.textContent = 'Subscribe';
	}
});
</script>

<style>
	/* Meeting card styling for homepage */
	.meeting-item-home .meeting-features {
		display: flex;
		gap: 0.75rem;
		flex-wrap: wrap;
		margin-top: 0.5rem;
	}
	
	.meeting-item-home .calendar-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		padding: 0.4rem 0.75rem;
		background: var(--primary-color, #0033cc);
		color: white;
		border-radius: 4px;
		font-size: 0.85rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}
	
	.meeting-item-home .feature-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		padding: 0.4rem 0.6rem;
		background: var(--bg-secondary, #fff5eb);
		border: 1px solid var(--border-color, #d4c5b9);
		border-radius: 4px;
		font-size: 0.85rem;
		color: var(--text-color, #5c4a3a);
		font-weight: 500;
	}
	
	@media (max-width: 640px) {
		.meeting-item-home .meeting-features {
			gap: 0.5rem;
		}
		
		.meeting-item-home .calendar-badge,
		.meeting-item-home .feature-badge {
			font-size: 0.8rem;
			padding: 0.35rem 0.5rem;
		}
	}
	
	/* Meetings section styling */
	.meetings-section {
		background: white;
		border-radius: 12px;
		border: 2px solid var(--border-color);
		padding: 2rem;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	}
	
	.meetings-section-header {
		margin-bottom: 2rem;
	}
	
	.meetings-section-header h2 {
		font-size: 1.75rem;
		color: var(--text-color);
		margin-bottom: 0.5rem;
	}
	
	.meetings-section-header p {
		color: var(--text-light);
		font-size: 1rem;
	}
	
	.meetings-subsection {
		margin-bottom: 2.5rem;
	}
	
	.meetings-subsection h3 {
		font-size: 1.25rem;
		color: var(--text-color);
		margin-bottom: 1rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid var(--border-color);
	}
	
	.recent-meetings-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	
	.meeting-list-item {
		display: flex;
		align-items: flex-start;
		gap: 1rem;
		padding: 1rem;
		background: white;
		border-radius: 8px;
		border: 1px solid var(--border-color);
		transition: all 0.2s;
		text-decoration: none;
		color: inherit;
	}
	
	.meeting-list-item:hover {
		border-color: var(--primary-color);
		background: #fafbff;
		box-shadow: 0 2px 8px rgba(0, 51, 204, 0.1);
		transform: translateX(4px);
	}
	
	.meeting-list-item .meeting-date-badge {
		flex-shrink: 0;
		width: 60px;
		text-align: center;
		padding: 0.5rem;
		background: var(--bg-secondary);
		border-radius: 6px;
	}
	
	.meeting-list-item .meeting-date-badge .month {
		display: block;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		color: var(--text-light);
	}
	
	.meeting-list-item .meeting-date-badge .day {
		display: block;
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--text-color);
		line-height: 1;
	}
	
	.meeting-list-item .meeting-info {
		flex-grow: 1;
		min-width: 0;
	}
	
	.meeting-list-item .meeting-title {
		font-size: 1rem;
		font-weight: 600;
		margin-bottom: 0.25rem;
		color: var(--text-color);
	}
	
	.meeting-list-item .meeting-type {
		font-size: 0.875rem;
		color: var(--text-light);
	}
	
	.recent-meetings-list {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: 1rem;
	}
	
	.upcoming-empty {
		padding: 2rem;
		text-align: center;
		background: var(--bg-secondary);
		border-radius: 8px;
		color: var(--text-light);
		font-style: italic;
	}
</style>

<div class="homepage-sections">
	<!-- Meetings Section -->
	<div class="meetings-section">
		<div class="meetings-section-header">
			<h2>Tribal Meetings and Events</h2>
			<p>Stay informed about tribal meetings, decisions, and community gatherings.</p>
		</div>
		
		<!-- Upcoming Meetings -->
		<div class="meetings-subsection">
			<h3>Upcoming Meetings & Events</h3>
			<div id="upcomingMeetingsContainer">
				<!-- Will be populated by JavaScript -->
			</div>
		</div>
		
		<!-- Recent Meetings -->
		<div class="meetings-subsection">
			<h3>Recent Meetings and Events</h3>
			<div id="recentMeetingsContainer" class="recent-meetings-list">
				<!-- Will be populated by JavaScript -->
			</div>
		</div>
		
		<div style="display: flex; gap: 2rem; align-items: center; justify-content: center; flex-wrap: wrap;">
			<a href="/meetings/" class="view-all-link">View All Meetings</a>
			<a href="https://calendar.google.com/calendar/ical/nativecalendar13%40gmail.com/public/basic.ics" class="view-all-link" target="_blank" rel="noopener noreferrer">
				<span style="display: inline-flex; align-items: center; gap: 0.5rem;">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.7;">
						<path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
					</svg>
					Event Calendar
				</span>
			</a>
		</div>
	</div>
</div>

<!-- Event Details Lightbox -->
<div id="eventLightbox" class="event-lightbox" style="display: none;">
	<div class="event-lightbox-overlay"></div>
	<div class="event-lightbox-content">
		<button class="event-lightbox-close" aria-label="Close">&times;</button>
		<div class="event-lightbox-body">
			<h2 id="eventTitle"></h2>
			<div class="event-details">
				<div class="event-detail-row">
					<strong>üìÖ Date:</strong>
					<span id="eventDate"></span>
				</div>
				<div class="event-detail-row" id="eventLocationRow" style="display: none;">
					<strong>üìç Location:</strong>
					<span id="eventLocation"></span>
				</div>
				<div class="event-detail-row" id="eventDescriptionRow" style="display: none;">
					<strong>üìù Description:</strong>
					<div id="eventDescription"></div>
				</div>
			</div>
			<div class="event-lightbox-actions">
				<a id="eventViewLink" href="#" target="_blank" rel="noopener noreferrer" class="event-view-button">View in Google Calendar</a>
			</div>
		</div>
	</div>
</div>

<script src="/js/members-config.js"></script>
<script src="/js/meetings-api.js"></script>
<script>
// Lightbox functions
function openEventLightbox(event) {
	const lightbox = document.getElementById('eventLightbox');
	const dateObj = new Date(event.date);
	const formattedDate = dateObj.toLocaleDateString('en-US', { 
		weekday: 'long', 
		year: 'numeric', 
		month: 'long', 
		day: 'numeric',
		hour: 'numeric',
		minute: '2-digit'
	});
	
	document.getElementById('eventTitle').textContent = event.title;
	document.getElementById('eventDate').textContent = formattedDate;
	
	// Show/hide location
	const locationRow = document.getElementById('eventLocationRow');
	if (event.location) {
		document.getElementById('eventLocation').textContent = event.location;
		locationRow.style.display = 'flex';
	} else {
		locationRow.style.display = 'none';
	}
	
	// Show/hide description
	const descriptionRow = document.getElementById('eventDescriptionRow');
	if (event.description) {
		document.getElementById('eventDescription').textContent = event.description;
		descriptionRow.style.display = 'flex';
	} else {
		descriptionRow.style.display = 'none';
	}
	
	// Set calendar link
	const viewLink = document.getElementById('eventViewLink');
	if (event.url && event.url !== '#') {
		viewLink.href = event.url;
		viewLink.style.display = 'inline-block';
	} else {
		viewLink.href = 'https://calendar.google.com/calendar/u/0/r?cid=nativecalendar13@gmail.com';
		viewLink.style.display = 'inline-block';
	}
	
	lightbox.style.display = 'flex';
	document.body.style.overflow = 'hidden';
}

function closeEventLightbox() {
	const lightbox = document.getElementById('eventLightbox');
	lightbox.style.display = 'none';
	document.body.style.overflow = '';
}

// Close on overlay click or close button
document.addEventListener('DOMContentLoaded', () => {
	const lightbox = document.getElementById('eventLightbox');
	const closeBtn = lightbox.querySelector('.event-lightbox-close');
	const overlay = lightbox.querySelector('.event-lightbox-overlay');
	
	closeBtn.addEventListener('click', closeEventLightbox);
	overlay.addEventListener('click', closeEventLightbox);
	
	// Close on escape key
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && lightbox.style.display === 'flex') {
			closeEventLightbox();
		}
	});
});

// Simple iCal parser for Google Calendar
function parseICalEvents(icalData) {
	const events = [];
	const eventBlocks = icalData.split('BEGIN:VEVENT');
	
	eventBlocks.forEach((block, index) => {
		if (index === 0) return; // Skip the header
		
		const event = {};
		const lines = block.split(/\r?\n/);
		
		lines.forEach(line => {
			// Handle SUMMARY (title)
			if (line.startsWith('SUMMARY:')) {
				event.title = line.replace('SUMMARY:', '').trim();
			}
			// Handle DTSTART (start date)
			else if (line.startsWith('DTSTART')) {
				const dateMatch = line.match(/DTSTART[^:]*:(\d{8}T?\d{0,6}Z?)/);
				if (dateMatch) {
					const dateStr = dateMatch[1];
					// Parse YYYYMMDDTHHMMSSZ format
					if (dateStr.includes('T')) {
						const year = dateStr.substr(0, 4);
						const month = dateStr.substr(4, 2);
						const day = dateStr.substr(6, 2);
						const hour = dateStr.substr(9, 2);
						const minute = dateStr.substr(11, 2);
						const second = dateStr.substr(13, 2);
						event.date = `${year}-${month}-${day}T${hour}:${minute}:${second}Z`;
					} else {
						// All-day event: YYYYMMDD
						const year = dateStr.substr(0, 4);
						const month = dateStr.substr(4, 2);
						const day = dateStr.substr(6, 2);
						event.date = `${year}-${month}-${day}T00:00:00Z`;
					}
				}
			}
			// Handle DESCRIPTION
			else if (line.startsWith('DESCRIPTION:')) {
				event.description = line.replace('DESCRIPTION:', '').trim();
			}
			// Handle LOCATION
			else if (line.startsWith('LOCATION:')) {
				event.location = line.replace('LOCATION:', '').trim();
			}
			// Handle URL
			else if (line.startsWith('URL:')) {
				event.url = line.replace('URL:', '').trim();
			}
		});
		
		if (event.title && event.date) {
			events.push(event);
		}
	});
	
	return events;
}

// Fetch Google Calendar events
async function fetchGoogleCalendarEvents() {
	const icalUrl = 'https://calendar.google.com/calendar/ical/nativecalendar13%40gmail.com/public/basic.ics';
	
	// Use CORS proxy to bypass browser restrictions
	const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(icalUrl);
	
	try {
		console.log('[Google Calendar] Fetching events from:', icalUrl);
		console.log('[Google Calendar] Using proxy:', proxyUrl);
		const response = await fetch(proxyUrl);
		
		if (!response.ok) {
			throw new Error(`HTTP ${response.status}: ${response.statusText}`);
		}
		
		const icalData = await response.text();
		console.log('[Google Calendar] Raw iCal data received:', icalData.substring(0, 200));
		const events = parseICalEvents(icalData);
		
		console.log('[Google Calendar] Parsed events:', events);
		
		// Add type and ensure URL exists
		return events.map(e => ({
			...e,
			type: 'calendar-event',
			url: e.url || 'https://calendar.google.com/calendar/u/0/r?cid=nativecalendar13@gmail.com'
		}));
	} catch (error) {
		console.error('[Google Calendar] Failed to fetch events:', error);
		console.error('[Google Calendar] Error details:', error.message);
		return [];
	}
}

// Fetch and display meetings + events
document.addEventListener('DOMContentLoaded', async () => {
	const upcomingContainer = document.getElementById('upcomingMeetingsContainer');
	const recentContainer = document.getElementById('recentMeetingsContainer');
	
	// Get all events from Hugo site data
	const hugoEvents = [
		{{ range where .Site.RegularPages "Type" "post" }}
			{{ if (in .Params.categories "events") }}
		{
			title: {{ .Title }},
			date: {{ .Date.Format "2006-01-02T15:04:05-0700" }},
			url: {{ .Permalink }},
			type: 'event'
		},
			{{ end }}
		{{ end }}
	].filter(e => e.title); // Remove empty entries
	
	console.log('[Homepage] Hugo events found:', hugoEvents);
	
	// Fetch Google Calendar events
	const googleEvents = await fetchGoogleCalendarEvents();
	
	// Combine all events
	const allEvents = [...hugoEvents, ...googleEvents];
	console.log('[Homepage] All events combined:', allEvents);
	
	const now = new Date();
	
	// Separate upcoming and past events
	const upcomingEvents = allEvents.filter(e => new Date(e.date) > now);
	const pastEvents = allEvents.filter(e => new Date(e.date) <= now);
	
	try {
		const api = new MeetingsAPIClient();
		const response = await api.getMeetings();
		const allMeetings = response.meetings;
		
		// Separate upcoming and past meetings
		const upcomingMeetings = allMeetings.filter(m => new Date(m.date) > now);
		const pastMeetings = allMeetings.filter(m => new Date(m.date) <= now);
		
		// Combine meetings and events, sort chronologically
		const upcomingItems = [
			...upcomingMeetings.map(m => ({ ...m, type: 'meeting' })),
			...upcomingEvents
		].sort((a, b) => new Date(a.date) - new Date(b.date)); // Earliest first
		
		const recentItems = [
			...pastMeetings.map(m => ({ ...m, type: 'meeting' })),
			...pastEvents
		].sort((a, b) => new Date(b.date) - new Date(a.date)); // Most recent first
		
		console.log('[Homepage] Upcoming items:', upcomingItems);
		console.log('[Homepage] Recent items:', recentItems);
		
		// Display upcoming meetings & events (up to 6)
		if (upcomingItems.length > 0) {
			upcomingContainer.innerHTML = upcomingItems.slice(0, 6).map((item, index) => {
				const dateObj = new Date(item.date);
				const monthShort = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase();
				const monthLong = dateObj.toLocaleString('en-US', { month: 'long' });
				const year = dateObj.getFullYear();
				const day = dateObj.getDate();
				
				if (item.type === 'event' || item.type === 'calendar-event') {
					// Display event
					const itemTitle = item.title;
					const eventType = item.type === 'calendar-event' ? 'Calendar Event' : 'Event';
					const eventLocation = item.location ? ` ‚Ä¢ ${item.location}` : '';
					const eventId = 'event-' + index;
					
					// Store event data for lightbox
					window['eventData_' + eventId] = item;
					
					return `
						<a href="#" class="meeting-list-item" data-event-id="${eventId}" onclick="openEventLightbox(window['eventData_${eventId}']); return false;">
							<div class="meeting-date-badge">
								<span class="month">${monthShort}</span>
								<span class="day">${day}</span>
							</div>
							<div class="meeting-info">
								<div class="meeting-title">${itemTitle}</div>
								<div class="meeting-type">${eventType}${eventLocation}</div>
							</div>
						</a>
					`;
				} else {
					// Display meeting
					const typeDisplay = api.getTypeDisplayName(item.type);
					const meetingTitle = `${monthLong} ${year} ${typeDisplay}`;
					const meetingUrl = `/meetings-detail/?id=${encodeURIComponent(item.id)}`;
					
					return `
						<a href="${meetingUrl}" class="meeting-list-item">
							<div class="meeting-date-badge">
								<span class="month">${monthShort}</span>
								<span class="day">${day}</span>
							</div>
							<div class="meeting-info">
								<div class="meeting-title">${meetingTitle}</div>
								<div class="meeting-type">${typeDisplay}</div>
							</div>
						</a>
					`;
				}
			}).join('');
		} else {
			upcomingContainer.innerHTML = '<div class="upcoming-empty">No upcoming meetings or events scheduled</div>';
		}
		
		// Display recent meetings & events (up to 8)
		if (recentItems.length > 0) {
			recentContainer.innerHTML = recentItems.slice(0, 8).map((item, index) => {
				const dateObj = new Date(item.date);
				const monthShort = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase();
				const monthLong = dateObj.toLocaleString('en-US', { month: 'long' });
				const year = dateObj.getFullYear();
				const day = dateObj.getDate();
				
				if (item.type === 'event' || item.type === 'calendar-event') {
					// Display event
					const itemTitle = item.title;
					const eventType = item.type === 'calendar-event' ? 'Calendar Event' : 'Event';
					const eventLocation = item.location ? ` ‚Ä¢ ${item.location}` : '';
					const eventId = 'recent-event-' + index;
					
					// Store event data for lightbox
					window['eventData_' + eventId] = item;
					
					return `
						<a href="#" class="meeting-list-item" data-event-id="${eventId}" onclick="openEventLightbox(window['eventData_${eventId}']); return false;">
							<div class="meeting-date-badge">
								<span class="month">${monthShort}</span>
								<span class="day">${day}</span>
							</div>
							<div class="meeting-info">
								<div class="meeting-title">${itemTitle}</div>
								<div class="meeting-type">${eventType}${eventLocation}</div>
							</div>
						</a>
					`;
				} else {
					// Display meeting
					const typeDisplay = api.getTypeDisplayName(item.type);
					const meetingTitle = `${monthLong} ${year} ${typeDisplay}`;
					const meetingUrl = `/meetings-detail/?id=${encodeURIComponent(item.id)}`;
					
					return `
						<a href="${meetingUrl}" class="meeting-list-item">
							<div class="meeting-date-badge">
								<span class="month">${monthShort}</span>
								<span class="day">${day}</span>
							</div>
							<div class="meeting-info">
								<div class="meeting-title">${meetingTitle}</div>
								<div class="meeting-type">${typeDisplay}</div>
							</div>
						</a>
					`;
				}
			}).join('');
		} else {
			recentContainer.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--text-light);">No recent meetings available.</p>';
		}
	} catch (error) {
		console.log('[Homepage] Meeting API unavailable:', error.message);
		
		// Fallback: show events even if meetings API fails
		if (upcomingEvents.length > 0) {
			upcomingContainer.innerHTML = upcomingEvents.slice(0, 6).map((item, index) => {
				const dateObj = new Date(item.date);
				const monthShort = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase();
				const day = dateObj.getDate();
				const eventType = item.type === 'calendar-event' ? 'Calendar Event' : 'Event';
				const eventLocation = item.location ? ` ‚Ä¢ ${item.location}` : '';
				const eventId = 'fallback-event-' + index;
				
				// Store event data for lightbox
				window['eventData_' + eventId] = item;
				
				return `
					<a href="#" class="meeting-list-item" data-event-id="${eventId}" onclick="openEventLightbox(window['eventData_${eventId}']); return false;">
						<div class="meeting-date-badge">
							<span class="month">${monthShort}</span>
							<span class="day">${day}</span>
						</div>
						<div class="meeting-info">
							<div class="meeting-title">${item.title}</div>
							<div class="meeting-type">${eventType}${eventLocation}</div>
						</div>
					</a>
				`;
			}).join('');
		} else {
			upcomingContainer.innerHTML = '<div class="upcoming-empty">No upcoming events scheduled</div>';
		}
		
		// Show recent events
		if (pastEvents.length > 0) {
			recentContainer.innerHTML = pastEvents.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 8).map((item, index) => {
				const dateObj = new Date(item.date);
				const monthShort = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase();
				const day = dateObj.getDate();
				const eventType = item.type === 'calendar-event' ? 'Calendar Event' : 'Event';
				const eventLocation = item.location ? ` ‚Ä¢ ${item.location}` : '';
				const eventId = 'fallback-recent-event-' + index;
				
				// Store event data for lightbox
				window['eventData_' + eventId] = item;
				
				return `
					<a href="#" class="meeting-list-item" data-event-id="${eventId}" onclick="openEventLightbox(window['eventData_${eventId}']); return false;">
						<div class="meeting-date-badge">
							<span class="month">${monthShort}</span>
							<span class="day">${day}</span>
						</div>
						<div class="meeting-info">
							<div class="meeting-title">${item.title}</div>
							<div class="meeting-type">${eventType}${eventLocation}</div>
						</div>
					</a>
				`;
			}).join('');
		} else {
			recentContainer.innerHTML = '<p style="padding: 2rem; text-align: center;"><a href="/meetings/" style="color: var(--link-color); text-decoration: none; font-weight: 500;">View tribal meetings ‚Üí</a></p>';
		}
	}
});
</script>

{{ end }}
