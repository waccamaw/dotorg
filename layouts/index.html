{{ define "main" }}

{{ $allPosts := where .Site.RegularPages "Type" "post" }}
{{ $paginator := .Paginate $allPosts 10 }}

<!-- Featured Hero Carousel (only on page 1) -->
{{ if eq $paginator.PageNumber 1 }}
{{ $featured := where .Site.RegularPages ".Params.categories" "intersect" (slice "featured") }}
{{ if $featured }}
	<div class="hero-carousel">
		{{ range first 1 $featured }}
			<article class="hero-slide">
				{{ if .Params.photos }}
					<div class="hero-background">
						<img src="{{ index .Params.photos 0 }}" alt="{{ .Title }}" loading="eager">
						<div class="hero-overlay"></div>
					</div>
				{{ end }}
				<div class="hero-content">
					<div class="hero-text">
						<span class="hero-label">Featured</span>
						<h1 class="hero-title">{{ .Title }}</h1>
					<div class="hero-meta">
						<time datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "January 2, 2006" }}
						</time>
						{{ with .Params.author }}
							{{ if reflect.IsMap . }}
								<span class="hero-author">
									{{ with .avatar }}<img src="{{ . }}" alt="{{ $.Params.author.full_name }}" class="author-avatar"> {{ end }}
									{{ .full_name | default .name }}
								</span>
							{{ else }}
								<span class="hero-author">{{ . }}</span>
							{{ end }}
						{{ end }}
					</div>
						<p class="hero-excerpt">{{ .Summary }}</p>
						<a href="{{ .Permalink }}" class="hero-cta">Read Full Story</a>
					</div>
				</div>
			</article>
		{{ end }}
	</div>
{{ end }}

<!-- Featured Posts Row (3 cards) -->
{{ $featuredPosts := after 1 (first 4 $featured) }}
{{ if $featuredPosts }}
<div class="featured-row">
	<h2 class="section-heading">Featured Stories</h2>
	<div class="featured-grid">
		{{ range $featuredPosts }}
			<article class="featured-card h-entry">
				{{ if .Params.photos }}
					<div class="card-image">
						<img src="{{ index .Params.photos 0 }}" alt="{{ .Title }}" loading="lazy">
					</div>
				{{ end }}
				<div class="card-content">
					<h3 class="card-title p-name">
						<a href="{{ .Permalink }}">{{ .Title }}</a>
					</h3>
					<div class="card-meta">
						<time class="dt-published" datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "Jan 2, 2006" }}
						</time>
					</div>
					<p class="card-excerpt">{{ .Summary | truncate 120 }}</p>
				</div>
			</article>
		{{ end }}
	</div>
</div>
{{ end }}
{{ end }}

<!-- Recent Posts Feed -->
<div class="h-feed home-feed">
	<h2>Latest Updates</h2>
	
	{{ range $paginator.Pages }}
		<article class="h-entry post-preview">
			<header class="post-header">
				{{ if .Title }}
					<h3 class="p-name post-title">
						<a href="{{ .Permalink }}">{{ .Title }}</a>
					</h3>
				{{ end }}
				
				<div class="post-meta">
					<time class="dt-published" datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
						{{ .Date.Format "January 2, 2006" }}
					</time>
					{{ with .Params.author }}
						{{ if reflect.IsMap . }}
							by <span class="p-author h-card">
								{{ with .avatar }}<img src="{{ . }}" alt="{{ $.Params.author.full_name }}" class="author-avatar"> {{ end }}
								{{ .full_name | default .name }}
							</span>
						{{ else }}
							by <span class="p-author h-card">{{ . }}</span>
						{{ end }}
					{{ end }}
					{{ if .Params.categories }}
						<span class="post-categories">
							{{ range .Params.categories }}
								<a href="/categories/{{ . | urlize }}/" class="category-badge">{{ . }}</a>
							{{ end }}
						</span>
					{{ end }}
				</div>
			</header>

			<div class="p-summary post-summary">
				{{ if .Title }}
					{{ .Summary }}
				{{ else }}
					{{ .Content }}
				{{ end }}
			</div>

			{{ if .Params.photos }}
				<div class="post-photos-preview">
					{{ range first 3 .Params.photos }}
						<img src="{{ . }}" alt="" loading="lazy">
					{{ end }}
					{{ if gt (len .Params.photos) 3 }}
						<span class="more-photos">+{{ sub (len .Params.photos) 3 }} more</span>
					{{ end }}
				</div>
			{{ end }}

			<div class="post-footer">
				<a href="{{ .Permalink }}" class="u-url read-more">Read more →</a>
			</div>
		</article>
	{{ end }}
	
	<!-- Pagination Controls -->
	{{ if or $paginator.HasPrev $paginator.HasNext }}
	<nav class="pagination">
		{{ if $paginator.HasPrev }}
			<a href="{{ $paginator.Prev.URL }}" class="pagination-prev">← Newer posts</a>
		{{ else }}
			<span class="pagination-prev disabled">← Newer posts</span>
		{{ end }}
		
		<span class="pagination-info">
			Page {{ $paginator.PageNumber }} of {{ $paginator.TotalPages }}
		</span>
		
		{{ if $paginator.HasNext }}
			<a href="{{ $paginator.Next.URL }}" class="pagination-next">Older posts →</a>
		{{ else }}
			<span class="pagination-next disabled">Older posts →</span>
		{{ end }}
	</nav>
	{{ end }}
</div>

{{ end }}
