{{ define "main" }}

{{ $allPosts := where .Site.RegularPages "Type" "post" }}

<!-- Featured Hero (1 post only) -->
{{ $featured := where .Site.RegularPages ".Params.categories" "intersect" (slice "featured") }}
{{ if $featured }}
	<div class="hero-carousel">
		{{ range first 1 $featured }}
			<article class="hero-slide">
				{{ if .Params.photos }}
					{{ $originalImage := index .Params.photos 0 }}
					{{ $heroImage := printf "https://micro.blog/photos/1800x/%s" $originalImage }}
					<div class="hero-background">
						<img src="{{ $heroImage }}" alt="{{ .Title }}" loading="eager">
						<div class="hero-overlay"></div>
					</div>
				{{ end }}
				<div class="hero-content">
					<div class="hero-text">
						<span class="hero-label">Featured</span>
						<h1 class="hero-title">{{ .Title }}</h1>
					<div class="hero-meta">
						<time datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "January 2, 2006" }}
						</time>
						{{ with .Params.author }}
							{{ if reflect.IsMap . }}
								<span class="hero-author">
									{{ with .avatar }}<img src="{{ . }}" alt="{{ $.Params.author.full_name }}" class="author-avatar"> {{ end }}
									{{ .full_name | default .name }}
								</span>
							{{ else }}
								<span class="hero-author">{{ . }}</span>
							{{ end }}
						{{ end }}
					</div>
						{{ if .Content }}
							<p class="hero-excerpt">{{ .Content | plainify | htmlUnescape | truncate 250 }}</p>
						{{ end }}
						<a href="{{ .Permalink }}" class="hero-cta">Read Full Story</a>
					</div>
				</div>
			</article>
		{{ end }}
	</div>
{{ end }}

<!-- Last 3 Blog Posts -->
<div class="recent-updates">
	<div class="updates-list">
	{{ range $index, $post := first 3 $allPosts }}
		<article class="update-item h-entry">
			{{ if $post.Params.photos }}
				{{ $originalImage := index $post.Params.photos 0 }}
				{{ $resizedImage := printf "https://micro.blog/photos/900x/%s" $originalImage }}
				<div class="update-image auto-layout-image" data-index="{{ $index }}" onclick="openLightbox('{{ $originalImage }}')">
					<img src="{{ $resizedImage }}" alt="{{ $post.Title }}" loading="lazy" data-src="{{ $originalImage }}">
				</div>
			{{ end }}
			<div class="update-content">
				<h3 class="p-name update-title">
					<a href="{{ $post.Permalink }}">{{ $post.Title }}</a>
				</h3>
				<div class="update-meta">
					<time class="dt-published" datetime="{{ $post.Date.Format "2006-01-02T15:04:05-0700" }}">
						{{ $post.Date.Format "January 2, 2006" }}
					</time>
					{{ if $post.Params.categories }}
						<span class="update-categories">
							{{ range $post.Params.categories }}
								<span class="category-badge">{{ . }}</span>
							{{ end }}
						</span>
					{{ end }}
				</div>
				{{ if $post.Content }}
					<p class="update-excerpt">{{ $post.Content | plainify | htmlUnescape | truncate 200 }}</p>
				{{ end }}
				<a href="{{ $post.Permalink }}" class="u-url update-link">Read more â†’</a>
				</div>
			</article>
		{{ end }}
	</div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
	<span class="lightbox-close">Ã—</span>
	<img id="lightbox-img" src="" alt="">
</div>

<script>
function openLightbox(src) {
	event.stopPropagation();
	document.getElementById('lightbox').classList.add('active');
	document.getElementById('lightbox-img').src = src;
	document.body.style.overflow = 'hidden';
}

function closeLightbox() {
	document.getElementById('lightbox').classList.remove('active');
	document.body.style.overflow = 'auto';
}

document.addEventListener('keydown', function(e) {
	if (e.key === 'Escape') {
		closeLightbox();
	}
});

// Auto-layout images based on aspect ratio
function autoLayoutImage(img) {
	if (img.naturalWidth && img.naturalHeight) {
		const aspectRatio = img.naturalWidth / img.naturalHeight;
		const container = img.closest('.auto-layout-image');
		
		if (!container) return;
		
		// If image is square or portrait (aspect ratio <= 1.2), float it right
		if (aspectRatio <= 1.2) {
			container.classList.add('floated-right');
		}
	}
}

document.addEventListener('DOMContentLoaded', function() {
	const images = document.querySelectorAll('.auto-layout-image img');
	images.forEach(img => {
		if (img.complete && img.naturalHeight !== 0) {
			autoLayoutImage(img);
		} else {
			img.addEventListener('load', function() {
				autoLayoutImage(img);
			});
		}
	});
});
</script>

<!-- Recent Updates Grid (all content) -->
<div class="homepage-sections">
	<div class="other-posts-section">
		<div class="posts-grid">
			{{ range $index, $post := after 3 (first 18 $allPosts) }}
				{{ $colorIndex := mod $index 6 }}
				<article class="post-card h-entry">
					{{ if .Params.photos }}
						{{ $originalImage := index .Params.photos 0 }}
						{{ $resizedImage := printf "https://micro.blog/photos/400x/%s" $originalImage }}
						<div class="post-card-image">
							<a href="{{ .Permalink }}">
								<img src="{{ $resizedImage }}" alt="{{ .Title }}" loading="lazy">
							</a>
						</div>
					{{ else }}
						<div class="post-card-placeholder post-card-color-{{ $colorIndex }}">
							<a href="{{ .Permalink }}">
								<span class="placeholder-icon">ðŸ“„</span>
							</a>
						</div>
					{{ end }}
					<div class="post-card-content">
						<h3 class="p-name post-card-title">
							<a href="{{ .Permalink }}">{{ .Title }}</a>
						</h3>
						<time class="dt-published post-card-date" datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "Jan 2, 2006" }}
						</time>
					</div>
				</article>
			{{ end }}
		</div>
		<a href="/updates/" class="view-all-link">View all updates â†’</a>
	</div>
</div>

<!-- Newsletter Signup -->
<div class="newsletter-signup">
	<div class="newsletter-content">
		<div class="newsletter-text">
			<h3>Stay Updated</h3>
			<p>Get Waccamaw news, event announcements, and cultural updates delivered to your inbox.</p>
		</div>
		<form class="newsletter-form" id="newsletterForm">
			<input 
				type="text" 
				name="name" 
				id="newsletter-name"
				placeholder="Your full name" 
				required
				aria-label="Full name for newsletter"
				style="display: none;"
			>
			<input 
				type="email" 
				name="email" 
				id="newsletter-email"
				placeholder="Your email address" 
				required
				aria-label="Email address for newsletter"
			>
			<button type="submit">Subscribe</button>
		</form>
	</div>
	<div id="newsletter-message" style="display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; text-align: center;"></div>
</div>

<script>
const newsletterForm = document.getElementById('newsletterForm');
const emailInput = document.getElementById('newsletter-email');
const nameInput = document.getElementById('newsletter-name');

// Show name field when email is focused
emailInput.addEventListener('focus', function() {
	if (nameInput.style.display === 'none') {
		nameInput.style.display = 'block';
		// Smooth scroll into view if needed
		setTimeout(() => {
			nameInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
		}, 100);
	}
});

newsletterForm.addEventListener('submit', async function(e) {
	e.preventDefault();
	
	const name = nameInput.value || 'Newsletter Subscriber';
	const email = emailInput.value;
	const submitButton = this.querySelector('button[type="submit"]');
	const messageDiv = document.getElementById('newsletter-message');
	
	// Disable button and show loading state
	submitButton.disabled = true;
	submitButton.textContent = 'Subscribing...';
	
	try {
		const response = await fetch('https://contact.waccamaw.org/api/contact', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				name: name,
				email: email,
				category: 'general',
				message: 'Newsletter subscription request',
				newsletter: true
			})
		});
		
		if (response.ok) {
			messageDiv.textContent = 'Thank you for subscribing! Please check your email to confirm your subscription.';
			messageDiv.style.display = 'block';
			messageDiv.style.backgroundColor = 'var(--success-bg, #d4edda)';
			messageDiv.style.color = 'var(--success-text, #155724)';
			this.reset();
		} else {
			throw new Error('Subscription failed');
		}
	} catch (error) {
		messageDiv.textContent = 'Sorry, there was an error. Please try again.';
		messageDiv.style.display = 'block';
		messageDiv.style.backgroundColor = 'var(--error-bg, #f8d7da)';
		messageDiv.style.color = 'var(--error-text, #721c24)';
	} finally {
		submitButton.disabled = false;
		submitButton.textContent = 'Subscribe';
	}
});
</script>

<style>
	/* Meeting card styling for homepage */
	.meeting-item-home .meeting-features {
		display: flex;
		gap: 0.75rem;
		flex-wrap: wrap;
		margin-top: 0.5rem;
	}
	
	.meeting-item-home .calendar-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		padding: 0.4rem 0.75rem;
		background: var(--primary-color, #0033cc);
		color: white;
		border-radius: 4px;
		font-size: 0.85rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}
	
	.meeting-item-home .feature-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		padding: 0.4rem 0.6rem;
		background: var(--bg-secondary, #fff5eb);
		border: 1px solid var(--border-color, #d4c5b9);
		border-radius: 4px;
		font-size: 0.85rem;
		color: var(--text-color, #5c4a3a);
		font-weight: 500;
	}
	
	@media (max-width: 640px) {
		.meeting-item-home .meeting-features {
			gap: 0.5rem;
		}
		
		.meeting-item-home .calendar-badge,
		.meeting-item-home .feature-badge {
			font-size: 0.8rem;
			padding: 0.35rem 0.5rem;
		}
	}
	
	/* Meetings section styling */
	.meetings-section {
		background: white;
		border-radius: 12px;
		border: 2px solid var(--border-color);
		padding: 2rem;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	}
	
	.meetings-section-header {
		margin-bottom: 2rem;
	}
	
	.meetings-section-header h2 {
		font-size: 1.75rem;
		color: var(--text-color);
		margin-bottom: 0.5rem;
	}
	
	.meetings-section-header p {
		color: var(--text-light);
		font-size: 1rem;
	}
	
	.meetings-subsection {
		margin-bottom: 2.5rem;
	}
	
	.meetings-subsection h3 {
		font-size: 1.25rem;
		color: var(--text-color);
		margin-bottom: 1rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid var(--border-color);
	}
	
	.recent-meetings-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	
	.meeting-list-item {
		display: flex;
		align-items: flex-start;
		gap: 1rem;
		padding: 1rem;
		background: white;
		border-radius: 8px;
		border: 1px solid var(--border-color);
		transition: all 0.2s;
		text-decoration: none;
		color: inherit;
	}
	
	.meeting-list-item:hover {
		border-color: var(--primary-color);
		background: #fafbff;
		box-shadow: 0 2px 8px rgba(0, 51, 204, 0.1);
		transform: translateX(4px);
	}
	
	.meeting-list-item .meeting-date-badge {
		flex-shrink: 0;
		width: 60px;
		text-align: center;
		padding: 0.5rem;
		background: var(--bg-secondary);
		border-radius: 6px;
	}
	
	.meeting-list-item .meeting-date-badge .month {
		display: block;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		color: var(--text-light);
	}
	
	.meeting-list-item .meeting-date-badge .day {
		display: block;
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--text-color);
		line-height: 1;
	}
	
	.meeting-list-item .meeting-info {
		flex-grow: 1;
		min-width: 0;
	}
	
	.meeting-list-item .meeting-title {
		font-size: 1rem;
		font-weight: 600;
		margin-bottom: 0.25rem;
		color: var(--text-color);
	}
	
	.meeting-list-item .meeting-type {
		font-size: 0.875rem;
		color: var(--text-light);
	}
	
	.recent-meetings-list {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: 1rem;
	}
	
	.upcoming-empty {
		padding: 2rem;
		text-align: center;
		background: var(--bg-secondary);
		border-radius: 8px;
		color: var(--text-light);
		font-style: italic;
	}
</style>

<div class="homepage-sections">
	<!-- Meetings Section -->
	<div class="meetings-section">
		<div class="meetings-section-header">
			<h2>Tribal Meetings</h2>
			<p>Stay informed about tribal meetings, decisions, and community gatherings.</p>
		</div>
		
		<!-- Upcoming Meetings -->
		<div class="meetings-subsection">
			<h3>Upcoming Meetings</h3>
			<div id="upcomingMeetingsContainer">
				<!-- Will be populated by JavaScript -->
			</div>
		</div>
		
		<!-- Recent Meetings -->
		<div class="meetings-subsection">
			<h3>Recent Meetings</h3>
			<div id="recentMeetingsContainer" class="recent-meetings-list">
				<!-- Will be populated by JavaScript -->
			</div>
		</div>
		
		<a href="/meetings/" class="view-all-link">View all meetings â†’</a>
	</div>
</div>

<script src="/js/members-config.js"></script>
<script src="/js/meetings-api.js"></script>
<script>
// Fetch and display meetings
document.addEventListener('DOMContentLoaded', async () => {
	const upcomingContainer = document.getElementById('upcomingMeetingsContainer');
	const recentContainer = document.getElementById('recentMeetingsContainer');
	
	try {
		const api = new MeetingsAPIClient();
		const response = await api.getMeetings();
		const allMeetings = response.meetings;
		
		// Separate upcoming and past meetings
		const now = new Date();
		const upcomingMeetings = allMeetings.filter(m => new Date(m.date) > now);
		const pastMeetings = allMeetings.filter(m => new Date(m.date) <= now);
		
		// Display upcoming meetings
		if (upcomingMeetings.length > 0) {
			upcomingContainer.innerHTML = upcomingMeetings.slice(0, 3).map(meeting => {
				const dateObj = new Date(meeting.date);
				const monthShort = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase();
				const monthLong = dateObj.toLocaleString('en-US', { month: 'long' });
				const year = dateObj.getFullYear();
				const day = dateObj.getDate();
				const typeDisplay = api.getTypeDisplayName(meeting.type);
				const meetingTitle = `${monthLong} ${year} ${typeDisplay}`;
				const meetingUrl = `/meetings-detail/?id=${encodeURIComponent(meeting.id)}`;
				
				return `
					<a href="${meetingUrl}" class="meeting-list-item">
						<div class="meeting-date-badge">
							<span class="month">${monthShort}</span>
							<span class="day">${day}</span>
						</div>
						<div class="meeting-info">
							<div class="meeting-title">${meetingTitle}</div>
							<div class="meeting-type">${typeDisplay}</div>
						</div>
					</a>
				`;
			}).join('');
		} else {
			upcomingContainer.innerHTML = '<div class="upcoming-empty">No upcoming meetings scheduled</div>';
		}
		
		// Display recent meetings (6 total - 2 rows of 3)
		if (pastMeetings.length > 0) {
			recentContainer.innerHTML = pastMeetings.slice(0, 6).map(meeting => {
				const dateObj = new Date(meeting.date);
				const monthShort = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase();
				const monthLong = dateObj.toLocaleString('en-US', { month: 'long' });
				const year = dateObj.getFullYear();
				const day = dateObj.getDate();
				const typeDisplay = api.getTypeDisplayName(meeting.type);
				const meetingTitle = `${monthLong} ${year} ${typeDisplay}`;
				const meetingUrl = `/meetings-detail/?id=${encodeURIComponent(meeting.id)}`;
				
				return `
					<a href="${meetingUrl}" class="meeting-list-item">
						<div class="meeting-date-badge">
							<span class="month">${monthShort}</span>
							<span class="day">${day}</span>
						</div>
						<div class="meeting-info">
							<div class="meeting-title">${meetingTitle}</div>
							<div class="meeting-type">${typeDisplay}</div>
						</div>
					</a>
				`;
			}).join('');
		} else {
			recentContainer.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--text-light);">No recent meetings available.</p>';
		}
	} catch (error) {
		console.log('[Homepage] Meeting API unavailable:', error.message);
		upcomingContainer.innerHTML = '<div class="upcoming-empty">Unable to load upcoming meetings</div>';
		recentContainer.innerHTML = '<p style="padding: 2rem; text-align: center;"><a href="/meetings/" style="color: var(--link-color); text-decoration: none; font-weight: 500;">View tribal meetings â†’</a></p>';
	}
});
</script>

{{ end }}
