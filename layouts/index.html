{{ define "main" }}

{{ $allPosts := where .Site.RegularPages "Type" "post" }}

<!-- Featured Hero (1 post only) -->
{{ $featured := where .Site.RegularPages ".Params.categories" "intersect" (slice "featured") }}
{{ if $featured }}
	<div class="hero-carousel">
		{{ range first 1 $featured }}
			<article class="hero-slide">
				{{ if .Params.photos }}
					{{ $originalImage := index .Params.photos 0 }}
					{{ $heroImage := printf "https://micro.blog/photos/1800x/%s" $originalImage }}
					<div class="hero-background">
						<img src="{{ $heroImage }}" alt="{{ .Title }}" loading="eager">
						<div class="hero-overlay"></div>
					</div>
				{{ end }}
				<div class="hero-content">
					<div class="hero-text">
						<span class="hero-label">Featured</span>
						<h1 class="hero-title">{{ .Title }}</h1>
					<div class="hero-meta">
						<time datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "January 2, 2006" }}
						</time>
						{{ with .Params.author }}
							{{ if reflect.IsMap . }}
								<span class="hero-author">
									{{ with .avatar }}<img src="{{ . }}" alt="{{ $.Params.author.full_name }}" class="author-avatar"> {{ end }}
									{{ .full_name | default .name }}
								</span>
							{{ else }}
								<span class="hero-author">{{ . }}</span>
							{{ end }}
						{{ end }}
					</div>
						<p class="hero-excerpt">{{ .Summary }}</p>
						<a href="{{ .Permalink }}" class="hero-cta">Read Full Story</a>
					</div>
				</div>
			</article>
		{{ end }}
	</div>
{{ end }}

<!-- Last 3 Blog Posts -->
<div class="recent-updates">
	<div class="updates-list">
	{{ range $index, $post := first 3 $allPosts }}
		<article class="update-item h-entry">
			{{ if $post.Params.photos }}
				{{ $originalImage := index $post.Params.photos 0 }}
				{{ $resizedImage := printf "https://micro.blog/photos/900x/%s" $originalImage }}
				<div class="update-image auto-layout-image" data-index="{{ $index }}" onclick="openLightbox('{{ $originalImage }}')">
					<img src="{{ $resizedImage }}" alt="{{ $post.Title }}" loading="lazy" data-src="{{ $originalImage }}">
				</div>
			{{ end }}
			<div class="update-content">
				<h3 class="p-name update-title">
					<a href="{{ $post.Permalink }}">{{ $post.Title }}</a>
				</h3>
				<div class="update-meta">
					<time class="dt-published" datetime="{{ $post.Date.Format "2006-01-02T15:04:05-0700" }}">
						{{ $post.Date.Format "January 2, 2006" }}
					</time>
					{{ if $post.Params.categories }}
						<span class="update-categories">
							{{ range $post.Params.categories }}
								<span class="category-badge">{{ . }}</span>
							{{ end }}
						</span>
					{{ end }}
				</div>
				<p class="update-excerpt">{{ $post.Summary | truncate 200 }}</p>
				<a href="{{ $post.Permalink }}" class="u-url update-link">Read more â†’</a>
				</div>
			</article>
		{{ end }}
	</div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
	<span class="lightbox-close">Ã—</span>
	<img id="lightbox-img" src="" alt="">
</div>

<script>
function openLightbox(src) {
	event.stopPropagation();
	document.getElementById('lightbox').classList.add('active');
	document.getElementById('lightbox-img').src = src;
	document.body.style.overflow = 'hidden';
}

function closeLightbox() {
	document.getElementById('lightbox').classList.remove('active');
	document.body.style.overflow = 'auto';
}

document.addEventListener('keydown', function(e) {
	if (e.key === 'Escape') {
		closeLightbox();
	}
});

// Auto-layout images based on aspect ratio
function autoLayoutImage(img) {
	if (img.naturalWidth && img.naturalHeight) {
		const aspectRatio = img.naturalWidth / img.naturalHeight;
		const container = img.closest('.auto-layout-image');
		
		if (!container) return;
		
		// If image is square or portrait (aspect ratio <= 1.2), float it right
		if (aspectRatio <= 1.2) {
			container.classList.add('floated-right');
		}
	}
}

document.addEventListener('DOMContentLoaded', function() {
	const images = document.querySelectorAll('.auto-layout-image img');
	images.forEach(img => {
		if (img.complete && img.naturalHeight !== 0) {
			autoLayoutImage(img);
		} else {
			img.addEventListener('load', function() {
				autoLayoutImage(img);
			});
		}
	});
});
</script>

<!-- Recent Updates Grid (all content) -->
<div class="homepage-sections">
	<div class="other-posts-section">
		<div class="posts-grid">
			{{ range $index, $post := after 3 (first 18 $allPosts) }}
				{{ $colorIndex := mod $index 6 }}
				<article class="post-card h-entry">
					{{ if .Params.photos }}
						{{ $originalImage := index .Params.photos 0 }}
						{{ $resizedImage := printf "https://micro.blog/photos/400x/%s" $originalImage }}
						<div class="post-card-image">
							<a href="{{ .Permalink }}">
								<img src="{{ $resizedImage }}" alt="{{ .Title }}" loading="lazy">
							</a>
						</div>
					{{ else }}
						<div class="post-card-placeholder post-card-color-{{ $colorIndex }}">
							<a href="{{ .Permalink }}">
								<span class="placeholder-icon">ðŸ“„</span>
							</a>
						</div>
					{{ end }}
					<div class="post-card-content">
						<h3 class="p-name post-card-title">
							<a href="{{ .Permalink }}">{{ .Title }}</a>
						</h3>
						<time class="dt-published post-card-date" datetime="{{ .Date.Format "2006-01-02T15:04:05-0700" }}">
							{{ .Date.Format "Jan 2, 2006" }}
						</time>
					</div>
				</article>
			{{ end }}
		</div>
		<a href="/updates/" class="view-all-link">View all updates â†’</a>
	</div>
</div>

<!-- Newsletter Signup -->
<div class="newsletter-signup">
	<div class="newsletter-content">
		<div class="newsletter-text">
			<h3>Stay Updated</h3>
			<p>Get Waccamaw news, event announcements, and cultural updates delivered to your inbox.</p>
		</div>
		<form class="newsletter-form" id="newsletterForm">
			<input 
				type="text" 
				name="name" 
				id="newsletter-name"
				placeholder="Your full name" 
				required
				aria-label="Full name for newsletter"
				style="display: none;"
			>
			<input 
				type="email" 
				name="email" 
				id="newsletter-email"
				placeholder="Your email address" 
				required
				aria-label="Email address for newsletter"
			>
			<button type="submit">Subscribe</button>
		</form>
	</div>
	<div id="newsletter-message" style="display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; text-align: center;"></div>
</div>

<script>
const newsletterForm = document.getElementById('newsletterForm');
const emailInput = document.getElementById('newsletter-email');
const nameInput = document.getElementById('newsletter-name');

// Show name field when email is focused
emailInput.addEventListener('focus', function() {
	if (nameInput.style.display === 'none') {
		nameInput.style.display = 'block';
		// Smooth scroll into view if needed
		setTimeout(() => {
			nameInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
		}, 100);
	}
});

newsletterForm.addEventListener('submit', async function(e) {
	e.preventDefault();
	
	const name = nameInput.value || 'Newsletter Subscriber';
	const email = emailInput.value;
	const submitButton = this.querySelector('button[type="submit"]');
	const messageDiv = document.getElementById('newsletter-message');
	
	// Disable button and show loading state
	submitButton.disabled = true;
	submitButton.textContent = 'Subscribing...';
	
	try {
		const response = await fetch('https://contact.waccamaw.org/api/contact', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				name: name,
				email: email,
				category: 'general',
				message: 'Newsletter subscription request',
				newsletter: true
			})
		});
		
		if (response.ok) {
			messageDiv.textContent = 'Thank you for subscribing! Please check your email to confirm your subscription.';
			messageDiv.style.display = 'block';
			messageDiv.style.backgroundColor = 'var(--success-bg, #d4edda)';
			messageDiv.style.color = 'var(--success-text, #155724)';
			this.reset();
		} else {
			throw new Error('Subscription failed');
		}
	} catch (error) {
		messageDiv.textContent = 'Sorry, there was an error. Please try again.';
		messageDiv.style.display = 'block';
		messageDiv.style.backgroundColor = 'var(--error-bg, #f8d7da)';
		messageDiv.style.color = 'var(--error-text, #721c24)';
	} finally {
		submitButton.disabled = false;
		submitButton.textContent = 'Subscribe';
	}
});
</script>

<style>
	/* Meeting card styling for homepage */
	.meeting-item-home .meeting-features {
		display: flex;
		gap: 0.75rem;
		flex-wrap: wrap;
		margin-top: 0.5rem;
	}
	
	.meeting-item-home .calendar-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		padding: 0.4rem 0.75rem;
		background: var(--primary-color, #0033cc);
		color: white;
		border-radius: 4px;
		font-size: 0.85rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}
	
	.meeting-item-home .feature-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		padding: 0.4rem 0.6rem;
		background: var(--bg-secondary, #fff5eb);
		border: 1px solid var(--border-color, #d4c5b9);
		border-radius: 4px;
		font-size: 0.85rem;
		color: var(--text-color, #5c4a3a);
		font-weight: 500;
	}
	
	@media (max-width: 640px) {
		.meeting-item-home .meeting-features {
			gap: 0.5rem;
		}
		
		.meeting-item-home .calendar-badge,
		.meeting-item-home .feature-badge {
			font-size: 0.8rem;
			padding: 0.35rem 0.5rem;
		}
	}
</style>

<div class="homepage-sections">
	<!-- Most Recent Meeting -->
	<div class="recent-meeting-section">
		<div id="recentMeetingContainer">
			<!-- Will be populated by JavaScript -->
		</div>
		<a href="/meetings/" class="view-all-link">View all meetings â†’</a>
	</div>
</div>

<script src="/js/members-config.js"></script>
<script src="/js/meetings-api.js"></script>
<script>
// Fetch and display most recent public meeting
document.addEventListener('DOMContentLoaded', async () => {
	const container = document.getElementById('recentMeetingContainer');
	
	try {
		const api = new MeetingsAPIClient();
		const meetings = await api.getMeetings();
		
		const recentMeeting = meetings.meetings[0];
		
		if (recentMeeting) {
			const dateObj = new Date(recentMeeting.date);
			const month = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase();
			const typeDisplay = api.getTypeDisplayName(recentMeeting.type);
			const typeBadge = api.getTypeBadgeClass(recentMeeting.type);
			const meetingUrl = `/meetings-detail/?id=${encodeURIComponent(recentMeeting.id)}`;
			
			container.innerHTML = `
				<a href="${meetingUrl}" class="meeting-item-home">
					<div class="meeting-content">
						<h3 class="meeting-title">${recentMeeting.title}</h3>
						<div class="meeting-meta">
							<span class="meeting-date">${api.formatDate(recentMeeting.date)}</span>
						</div>
						<div class="meeting-features">
							<span class="calendar-badge ${typeBadge}">${month} ${typeDisplay}</span>
							${recentMeeting.hasRecording ? '<span class="feature-badge">â–¶ Recording</span>' : ''}
							${recentMeeting.hasTranscript ? '<span class="feature-badge">âŽ™ Transcript</span>' : ''}
							${recentMeeting.hasNotes ? '<span class="feature-badge">â—‰ Notes</span>' : ''}
						</div>
					</div>
				</a>
			`;
		} else {
			container.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--text-light);">No recent meetings available.</p>';
		}
	} catch (error) {
		console.log('[Homepage] Meeting API unavailable:', error.message);
		container.innerHTML = '<p style="padding: 2rem; text-align: center;"><a href="/meetings/" style="color: var(--link-color); text-decoration: none; font-weight: 500;">View tribal meetings â†’</a></p>';
	}
});
</script>

{{ end }}
