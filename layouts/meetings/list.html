{{ define "main" }}

<div class="meetings-page">
	<header class="page-header">
		<h1 class="page-title">Tribal Meetings</h1>
		<p class="page-description">
			Browse summaries and minutes from tribal open meetings, executive sessions, and community gatherings from 2008 to present.
		</p>
		<div id="authStatus" class="auth-status"></div>
	</header>

	<!-- NEW API-POWERED EXPERIENCE -->
	<section class="meetings-section new-experience">
		<div class="section-header">
			<h2>ðŸ†• New Meetings Archive (API-Powered)</h2>
			<p style="color: #666; font-size: 0.9em; margin-top: 0.5em;">
				Real-time data from Cloudflare KV with authentication-based visibility filtering
			</p>
		</div>

		<!-- Year Filter Timeline -->
		<div class="year-filter-container">
			<div class="year-filter-header">
				<h3 class="filter-label">Filter by Year</h3>
				<button id="resetFilter" class="reset-filter" style="display: none;">Show All Years</button>
			</div>
			<div class="year-timeline">
				<div class="timeline-track">
					<div class="timeline-years" id="timelineYears">
						<!-- Years will be generated by JS -->
					</div>
					<div class="timeline-indicator" id="timelineIndicator"></div>
				</div>
			</div>
			<div class="selected-year-display">
				<span id="selectedYearText">Loading...</span>
			</div>
		</div>

		<div class="meetings-stats">
			<div class="stat-card">
				<span class="stat-number" id="totalCount">-</span>
				<span class="stat-label">Total Meetings</span>
			</div>
			<div class="stat-card">
				<span class="stat-number" id="displayedCount">-</span>
				<span class="stat-label">Displayed</span>
			</div>
			<div class="stat-card">
				<span class="stat-number" id="yearCount">-</span>
				<span class="stat-label">Years</span>
			</div>
		</div>

		<div class="meetings-list" id="meetingsList">
			<!-- Meetings will be rendered by JavaScript -->
		</div>
	</section>

	<!-- CLASSIC HUGO EXPERIENCE -->
	<section class="meetings-section classic-experience" style="margin-top: 4em; padding-top: 3em; border-top: 2px dashed #ddd;">
		<div class="section-header">
			<h2>ðŸ“š Classic Archive (Hugo Static)</h2>
			<p style="color: #666; font-size: 0.9em; margin-top: 0.5em;">
				All meetings from content files (will be migrated to new system)
			</p>
		</div>

		{{- $meetings := where .Site.RegularPages "Section" "meetings" -}}
		{{- $meetings = sort $meetings ".Date" "desc" -}}
		
		<!-- Year Filter Timeline -->
		<div class="year-filter-container">
			<div class="year-filter-header">
				<h3 class="filter-label">Filter by Year</h3>
				<button id="resetYearFilterClassic" class="reset-filter">Show All Years</button>
			</div>
			<div class="year-timeline">
				<div class="timeline-track">
					<div class="timeline-years" id="timelineYearsClassic">
						<!-- Years will be generated by JS -->
					</div>
					<div class="timeline-indicator" id="timelineIndicatorClassic"></div>
				</div>
			</div>
			<div class="selected-year-display">
				<span id="selectedYearTextClassic">Showing all years</span>
			</div>
		</div>

		<div class="meetings-stats">
			<div class="stat-card">
				<span class="stat-number" id="totalCountClassic">{{ len $meetings }}</span>
				<span class="stat-label">Total Meetings</span>
			</div>
			<div class="stat-card">
				<span class="stat-number" id="displayedCountClassic">{{ len $meetings }}</span>
				<span class="stat-label">Displayed</span>
			</div>
			<div class="stat-card">
				<span class="stat-number" id="yearCountClassic">-</span>
				<span class="stat-label">Years</span>
			</div>
		</div>

		<div class="meetings-list" id="meetingsListClassic">
			{{ $currentYear := "" }}
			{{ range $meetings }}
				{{ $year := .Date.Format "2006" }}
				
				{{ if ne $year $currentYear }}
					{{ if ne $currentYear "" }}
						</div></div>
					{{ end }}
					<div class="meetings-year" data-year="{{ $year }}">
						<h3 class="year-heading">{{ $year }} Meetings</h3>
						<div class="year-meetings">
					{{ $currentYear = $year }}
				{{ end }}
				
				<a href="{{ .Permalink }}" class="meeting-item" data-year="{{ $year }}">
					<div class="meeting-calendar">
						<div class="calendar-month">{{ .Date.Format "Jan" }}</div>
						{{ if in .Title "Open Meeting" }}
							<div class="calendar-label">Open<br>Meeting</div>
						{{ else if in .Title "Executive" }}
							<div class="calendar-label">Executive</div>
						{{ else }}
							<div class="calendar-label">Meeting</div>
						{{ end }}
					</div>
					<div class="meeting-info">
						<h4 class="meeting-title">
							{{ .Title }}
						</h4>
					{{ with .Params.author }}
						{{ if reflect.IsMap . }}
							{{ if .full_name }}
								<span class="meeting-author">Posted by {{ .full_name }}</span>
							{{ end }}
						{{ else }}
							<span class="meeting-author">Posted by {{ . }}</span>
						{{ end }}
					{{ end }}
						{{ if .Summary }}
							<p class="meeting-summary">{{ .Summary | truncate 150 }}</p>
						{{ end }}
					</div>
				</a>
			{{ end }}
			
			{{ if ne $currentYear "" }}
				</div></div>
			{{ end }}
		</div>

		<script>
		// Classic year filter functionality (scoped to avoid conflicts)
		(function() {
			const meetingsList = document.getElementById('meetingsListClassic');
			const timelineYears = document.getElementById('timelineYearsClassic');
			const timelineIndicator = document.getElementById('timelineIndicatorClassic');
			const selectedYearText = document.getElementById('selectedYearTextClassic');
			const resetButton = document.getElementById('resetYearFilterClassic');
			const displayedCount = document.getElementById('displayedCountClassic');
			const yearCountEl = document.getElementById('yearCountClassic');
			
			// Get all unique years from the meetings
			const allMeetings = Array.from(meetingsList.querySelectorAll('.meeting-item'));
			const years = [...new Set(allMeetings.map(m => m.dataset.year))].sort().reverse();
			
			let selectedYear = null;
			
			// Generate year buttons
			years.forEach(year => {
				const yearBtn = document.createElement('button');
				yearBtn.className = 'year-btn';
				yearBtn.dataset.year = year;
				yearBtn.textContent = year;
				yearBtn.addEventListener('click', () => filterByYear(year));
				timelineYears.appendChild(yearBtn);
			});
			
			// Update year count
			if (yearCountEl) yearCountEl.textContent = years.length;
			
			function filterByYear(year) {
				selectedYear = year;
				
				// Update UI
				timelineYears.querySelectorAll('.year-btn').forEach(btn => {
					btn.classList.toggle('active', btn.dataset.year === year);
				});
				
				// Filter meetings
				let visibleCount = 0;
				meetingsList.querySelectorAll('.meetings-year').forEach(yearSection => {
					const shouldShow = yearSection.dataset.year === year;
					yearSection.style.display = shouldShow ? 'block' : 'none';
					if (shouldShow) {
						visibleCount += yearSection.querySelectorAll('.meeting-item').length;
					}
				});
				
				// Update stats
				displayedCount.textContent = visibleCount;
				selectedYearText.textContent = `Showing ${visibleCount} meetings from ${year}`;
				resetButton.style.display = 'inline-block';
				
				// Scroll indicator
				const activeBtn = timelineYears.querySelector('.year-btn.active');
				if (activeBtn) {
					const position = activeBtn.offsetLeft + (activeBtn.offsetWidth / 2);
					timelineIndicator.style.left = position + 'px';
					timelineIndicator.style.opacity = '1';
				}
			}
			
			function resetFilter() {
				selectedYear = null;
				
				// Reset UI
				timelineYears.querySelectorAll('.year-btn').forEach(btn => {
					btn.classList.remove('active');
				});
				
				// Show all meetings
				meetingsList.querySelectorAll('.meetings-year').forEach(yearSection => {
					yearSection.style.display = 'block';
				});
				
				// Update stats
				displayedCount.textContent = allMeetings.length;
				selectedYearText.textContent = 'Showing all years';
				resetButton.style.display = 'none';
				timelineIndicator.style.opacity = '0';
			}
			
			resetButton.addEventListener('click', resetFilter);
			resetButton.style.display = 'none';
		})();
		</script>
	</section>
	
	<!-- Include configuration, API client, and app -->
	<script src="/js/members-config.js"></script>
	<script src="/js/meetings-api.js"></script>
	<script src="/js/meetings-app.js"></script>
</div>

{{ end }}
