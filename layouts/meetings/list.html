{{ define "main" }}

<div class="meetings-page">
	<header class="page-header">
		<h1 class="page-title">Tribal Meetings</h1>
		<p class="page-description">
			Browse summaries and minutes from tribal open meetings, executive sessions, and community gatherings from 2008 to present.
		</p>
		<div id="authStatus" class="auth-status"></div>
	</header>

	<!-- NEW API-POWERED EXPERIENCE -->
	<section class="meetings-section new-experience">
		<!-- Category Filter Buttons -->
		<div class="category-filter-container" style="max-width: 900px; margin: 1.5rem auto; padding: 0 1.5rem;">
			<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
				<h3 style="margin: 0; font-size: 1.1rem; color: var(--text-color);">Filter by Type</h3>
				<button id="resetFilter" class="reset-filter" style="display: none; padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: var(--text-color);">Show All</button>
			</div>
			<div id="categoryButtons" style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
				<!-- Category buttons will be generated by JS -->
			</div>
		</div>

		<div class="meetings-list" id="meetingsList">
			<!-- Meetings will be rendered by JavaScript -->
		</div>
	</section>

	<!-- Include configuration, API client, and app -->
	<script src="/js/members-config.js"></script>
	<script src="/js/meetings-api.js"></script>
	<script src="/js/meetings-app.js"></script>

	{{- $meetings := where .Site.RegularPages "Section" "meetings" -}}
	{{- $meetings = sort $meetings ".Date" "desc" -}}
	{{- $recentMeetings := where $meetings "Date.Year" "ge" 2024 -}}

	<!-- LEGACY ARCHIVE DIVIDER -->
	<div class="legacy-archive-divider" style="max-width: 900px; margin: 4rem auto 3rem; padding: 2rem 1.5rem; border-top: 2px solid var(--border-color);">
		<h2 style="font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--text-color);">ðŸ“š Legacy Meeting Archive</h2>
		<p style="color: var(--text-light); font-size: 1rem; line-height: 1.6;">
			Historical meeting records from our previous system (2008â€“2024).
			<span style="font-style: italic; display: block; margin-top: 0.5rem;">These will be gradually migrated to the new system above.</span>
		</p>
	</div>

	<!-- LEGACY HUGO CONTENT ARCHIVE -->
	<section class="meetings-section legacy-archive">
	
	<!-- Year Filter Timeline -->
	<div class="year-filter-container legacy-filter">
		<div class="year-filter-header">
			<h2 class="filter-label">Filter by Year</h2>
			<button id="legacyResetYearFilter" class="reset-filter">Show All Years</button>
		</div>
		<div class="year-timeline">
			<div class="timeline-track">
				<div class="timeline-years" id="legacyTimelineYears">
					<!-- Years will be generated by JS -->
				</div>
				<div class="timeline-indicator" id="legacyTimelineIndicator"></div>
			</div>
		</div>
		<div class="selected-year-display">
			<span id="legacySelectedYearText">Showing 2024-2025</span>
		</div>
	</div>

	<div class="meetings-stats legacy-stats">
		<div class="stat-card">
			<span class="stat-number" id="legacyTotalCount">{{ len $meetings }}</span>
			<span class="stat-label">Total Legacy</span>
		</div>
		<div class="stat-card">
			<span class="stat-number" id="legacyDisplayedCount">{{ len $recentMeetings }}</span>
			<span class="stat-label">Displayed</span>
		</div>
		<div class="stat-card">
			<span class="stat-number" id="legacyYearCount">2</span>
			<span class="stat-label">Years Shown</span>
		</div>
	</div>

	<div class="meetings-list legacy-list" id="legacyMeetingsList">
		{{ $currentYear := "" }}
		{{ range $recentMeetings }}
			{{ $year := .Date.Format "2006" }}
			
			{{ if ne $year $currentYear }}
				{{ if ne $currentYear "" }}
						</div>
					</div>
				{{ end }}
				<div class="meetings-year" data-year="{{ $year }}">
					<h2 class="year-heading accordion-header {{ if eq $year "2025" }}expanded{{ end }}"
						onclick="this.classList.toggle('expanded'); this.nextElementSibling.classList.toggle('collapsed');"
						style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; padding: 1rem; margin-bottom: 0; background: var(--bg-secondary, #fff5eb); border-radius: 8px; transition: all 0.2s ease;"
						onmouseover="this.style.background='#f0e6dc';"
						onmouseout="this.style.background='var(--bg-secondary, #fff5eb)';">
						<span>{{ $year }} Meetings</span>
						<svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s ease; transform: rotate({{ if eq $year "2025" }}180deg{{ else }}0deg{{ end }});">
							<polyline points="6 9 12 15 18 9"></polyline>
						</svg>
					</h2>
					<div class="year-meetings {{ if ne $year "2025" }}collapsed{{ end }}" style="overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease; {{ if eq $year "2025" }}max-height: 10000px; opacity: 1; margin-top: 1rem;{{ else }}max-height: 0; opacity: 0; margin-top: 0;{{ end }}">
				{{ $currentYear = $year }}
			{{ end }}
			
			<a href="{{ .Permalink }}" class="meeting-item" data-year="{{ $year }}">
				<div class="meeting-calendar">
					<div class="calendar-month">{{ .Date.Format "Jan" }}</div>
					{{ if in .Title "Open Meeting" }}
						<div class="calendar-label">Open<br>Meeting</div>
					{{ else if in .Title "Executive" }}
						<div class="calendar-label">Executive</div>
					{{ else }}
						<div class="calendar-label">Meeting</div>
					{{ end }}
				</div>
				<div class="meeting-info">
					<h3 class="meeting-title">
						{{ .Title }}
					</h3>
				{{ with .Params.author }}
					{{ if reflect.IsMap . }}
						{{ if .full_name }}
							<span class="meeting-author">Posted by {{ .full_name }}</span>
						{{ end }}
					{{ else }}
						<span class="meeting-author">Posted by {{ . }}</span>
					{{ end }}
				{{ end }}
					{{ if .Summary }}
						<p class="meeting-summary">{{ .Summary | truncate 150 }}</p>
					{{ end }}
				</div>
			</a>
		{{ end }}
		
		{{ if ne $currentYear "" }}
				</div>
			</div>
		{{ end }}
	</div>

	</section>

	<script>
	// Legacy archive year filter functionality
	(function() {
		const meetingsList = document.getElementById('legacyMeetingsList');
		const timelineYears = document.getElementById('legacyTimelineYears');
		const timelineIndicator = document.getElementById('legacyTimelineIndicator');
		const selectedYearText = document.getElementById('legacySelectedYearText');
		const resetButton = document.getElementById('legacyResetYearFilter');
		const displayedCount = document.getElementById('legacyDisplayedCount');
		
		// Get all unique years from the legacy meetings
		const allMeetings = Array.from(document.querySelectorAll('.legacy-archive .meeting-item'));
		const years = [...new Set(allMeetings.map(m => m.dataset.year))].sort();
		
		let selectedYear = null;
		
		// Generate year buttons
		years.forEach(year => {
			const yearBtn = document.createElement('button');
			yearBtn.className = 'year-btn';
			yearBtn.dataset.year = year;
			yearBtn.textContent = year;
			yearBtn.addEventListener('click', () => filterByYear(year));
			timelineYears.appendChild(yearBtn);
		});
		
		// Update year count
		document.getElementById('legacyYearCount').textContent = years.length;
		
		function filterByYear(year) {
			selectedYear = year;
			
			// Update UI
			document.querySelectorAll('.year-btn').forEach(btn => {
				btn.classList.toggle('active', btn.dataset.year === year);
			});
			
			// Filter meetings
			let visibleCount = 0;
			document.querySelectorAll('.legacy-archive .meetings-year').forEach(yearSection => {
				const shouldShow = yearSection.dataset.year === year;
				yearSection.style.display = shouldShow ? 'block' : 'none';
				if (shouldShow) {
					visibleCount += yearSection.querySelectorAll('.meeting-item').length;
				}
			});
			
			// Update stats
			displayedCount.textContent = visibleCount;
			selectedYearText.textContent = `Showing ${visibleCount} meetings from ${year}`;
			resetButton.style.display = 'inline-block';
			
			// Scroll indicator
			const activeBtn = document.querySelector('.year-btn.active');
			if (activeBtn) {
				const rect = activeBtn.getBoundingClientRect();
				const containerRect = timelineYears.getBoundingClientRect();
				const position = activeBtn.offsetLeft + (activeBtn.offsetWidth / 2);
				timelineIndicator.style.left = position + 'px';
				timelineIndicator.style.opacity = '1';
			}
		}
		
		function resetFilter() {
			selectedYear = null;
			
			// Reset UI
			document.querySelectorAll('.year-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			
			// Show all meetings
			document.querySelectorAll('.legacy-archive .meetings-year').forEach(yearSection => {
				yearSection.style.display = 'block';
			});
			
			// Update stats
			displayedCount.textContent = allMeetings.length;
			selectedYearText.textContent = 'Showing all years';
			resetButton.style.display = 'none';
			timelineIndicator.style.opacity = '0';
		}
		
		resetButton.addEventListener('click', resetFilter);
		resetButton.style.display = 'none';
	})();
	</script>
</div>

{{ end }}
