{{ define "main" }}
<!-- Google reCAPTCHA v3 -->
<!-- Site key is public and safe to expose in frontend code -->
<script src="https://www.google.com/recaptcha/api.js?render=6LfVNqEqAAAAANiQOLXBCVxv4TZjzqY5d0d8dN8i"></script>

<div class="contact-container">
  <div class="contact-content">
    <div class="contact-header">
      <h1 class="contact-title">{{ .Title }}</h1>
      <div class="contact-intro">
        {{ .Content }}
      </div>
    </div>
    
    <div id="loading-message" class="loading-message">
      <div class="loading-spinner"></div>
      <p>Loading contact form...</p>
    </div>
    
    <div id="error-message" class="error-notice" style="display: none;">
      <div class="notice-icon">‚ö†Ô∏è</div>
      <div class="notice-content">
        <strong>Error:</strong> <span id="error-text"></span>
      </div>
    </div>
    
    <form id="contact-form" class="contact-form" style="display: none;">
      <div class="form-group">
        <label for="name" class="form-label">
          Full Name <span class="required">*</span>
        </label>
        <input 
          type="text" 
          id="name" 
          name="name" 
          required 
          class="form-input"
        >
      </div>
      
      <div class="form-group">
        <label for="email" class="form-label">
          Email Address <span class="required">*</span>
        </label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          required 
          class="form-input"
        >
      </div>
      
      <div class="form-group">
        <label for="phone" class="form-label">
          Phone Number
        </label>
        <input 
          type="tel" 
          id="phone" 
          name="phone" 
          class="form-input"
          placeholder="(843) 555-1234"
        >
      </div>
      
      <div class="form-group">
        <label for="category" class="form-label">
          Category <span class="required">*</span>
        </label>
        <select 
          id="category" 
          name="category" 
          required 
          class="form-select"
        >
          <option value="">Select a category...</option>
        </select>
        <small id="category-description" class="form-help"></small>
      </div>
      
      <div id="custom-fields-container"></div>
      
      <div class="form-group">
        <label for="message" class="form-label">
          Message <span class="required">*</span>
        </label>
        <textarea 
          id="message" 
          name="message" 
          required 
          rows="6"
          class="form-textarea"
          placeholder="How can we help you?"
        ></textarea>
      </div>
      
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            id="newsletter" 
            name="newsletter" 
            value="true"
            class="form-checkbox"
          >
          <span>Subscribe to our newsletter for updates and events</span>
        </label>
      </div>
      
      <div class="recaptcha-notice">
        <p>This site is protected by reCAPTCHA and the Google 
          <a href="https://policies.google.com/privacy" target="_blank" rel="noopener noreferrer">Privacy Policy</a> and 
          <a href="https://policies.google.com/terms" target="_blank" rel="noopener noreferrer">Terms of Service</a> apply.
        </p>
      </div>
      
      <div class="form-group">
        <button 
          type="submit" 
          id="submit-btn"
          class="submit-button"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m22 2-7 20-4-9-9-4Z"></path>
            <path d="M22 2 11 13"></path>
          </svg>
          Send Message
        </button>
      </div>
      
      <div id="form-message" class="form-message" style="display: none;"></div>
    </form>
    
    <div class="tribal-info-section">
      <div class="info-grid">
        <div class="info-card">
          <h3>üìç Tribal Office</h3>
          <div class="office-details">
            <p class="office-name">Waccamaw Indian People</p>
            <p class="office-address">
              591 Bluewater Road<br>
              Aynor, SC 29511
            </p>
            <p class="office-phone">
              <strong>Phone:</strong> (843) 358-0700
            </p>
            <p class="office-hours">
              <strong>Office Hours:</strong><br>
              Office hours vary<br>
              <em>Please call ahead</em>
            </p>
          </div>
        </div>
        
        <div class="info-card">
          <h3>üèõÔ∏è Tribal Government</h3>
          <div class="government-info">
            <p><strong>Status:</strong> State-Recognized Tribe</p>
            <p><strong>Recognized:</strong> 2005</p>
            <p><strong>Location:</strong> Dog Bluff Community</p>
            <p><strong>County:</strong> Horry County, South Carolina</p>
            <p class="services-note">
              We serve our tribal members and the surrounding community with cultural preservation, enrollment services, and educational programs.
            </p>
          </div>
        </div>
      </div>
      
      <div class="map-section">
        <h3>üìå Visit Our Tribal Grounds</h3>
        <div class="map-container">
          <iframe 
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3307.8!2d-79.1!3d33.98!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzPCsDU4JzQ4LjAiTiA3OcKwMDYnMDAuMCJX!5e0!3m2!1sen!2sus!4v1234567890"
            width="100%" 
            height="400" 
            style="border:0;" 
            allowfullscreen="" 
            loading="lazy" 
            referrerpolicy="no-referrer-when-downgrade"
            title="Waccamaw Indian People Tribal Grounds">
          </iframe>
          <p class="map-note">
            <strong>Directions:</strong> Located in the historic Dog Bluff community near Aynor, SC. 
            From US-501, take Bluewater Road to our tribal office.
          </p>
        </div>
      </div>
      
      <div class="community-notice">
        <p>
          <strong>üåü About Our Tribe:</strong> The Waccamaw Indian People are South Carolina's first state-recognized tribe, 
          with deep roots in the Dog Bluff community. We are committed to preserving our culture, 
          serving our members, and building strong relationships with our neighbors.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // Configuration
  const API_BASE_URL = window.location.hostname === 'localhost' 
    ? 'http://localhost:8788' 
    : 'https://contact.waccamaw.org';
  
  // reCAPTCHA site key (public key, safe to expose in frontend)
  const RECAPTCHA_SITE_KEY = '6LfVNqEqAAAAANiQOLXBCVxv4TZjzqY5d0d8dN8i';
  
  let formConfig = null;
  
  // DOM Elements
  const loadingMessage = document.getElementById('loading-message');
  const errorMessage = document.getElementById('error-message');
  const errorText = document.getElementById('error-text');
  const contactForm = document.getElementById('contact-form');
  const categorySelect = document.getElementById('category');
  const categoryDescription = document.getElementById('category-description');
  const customFieldsContainer = document.getElementById('custom-fields-container');
  const submitBtn = document.getElementById('submit-btn');
  const formMessage = document.getElementById('form-message');
  
  // Store original button HTML for restoration
  let originalButtonHTML = null;
  
  // Load form configuration
  async function loadFormConfig() {
    try {
      const response = await fetch(`${API_BASE_URL}/api/config`);
      
      if (!response.ok) {
        throw new Error(`Failed to load form configuration: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Failed to load configuration');
      }
      
      formConfig = data.config;
      renderForm();
      
    } catch (error) {
      console.error('Error loading form config:', error);
      showError(`Unable to load contact form. Please try again later or email us directly at doug@waccamaw.org`);
    }
  }
  
  // Render form with categories
  function renderForm() {
    loadingMessage.style.display = 'none';
    contactForm.style.display = 'block';
    
    // Store original button HTML after form is visible
    if (!originalButtonHTML && submitBtn) {
      originalButtonHTML = submitBtn.innerHTML;
    }
    
    // Populate categories
    formConfig.categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.name;
      option.textContent = category.label;
      option.dataset.description = category.description || '';
      option.dataset.customFields = JSON.stringify(category.customFields || []);
      categorySelect.appendChild(option);
    });
    
    // Category change handler
    categorySelect.addEventListener('change', handleCategoryChange);
  }
  
  // Handle category selection
  function handleCategoryChange(e) {
    const selectedOption = e.target.options[e.target.selectedIndex];
    
    if (selectedOption.value) {
      // Show description
      categoryDescription.textContent = selectedOption.dataset.description || '';
      
      // Render custom fields
      const customFields = JSON.parse(selectedOption.dataset.customFields || '[]');
      renderCustomFields(customFields);
    } else {
      categoryDescription.textContent = '';
      customFieldsContainer.innerHTML = '';
    }
  }
  
  // Render custom fields for selected category
  function renderCustomFields(fields) {
    customFieldsContainer.innerHTML = '';
    
    fields.forEach(field => {
      const fieldGroup = document.createElement('div');
      fieldGroup.className = 'form-group';
      
      const label = document.createElement('label');
      label.setAttribute('for', `custom-${field.name}`);
      label.className = 'form-label';
      label.innerHTML = `${field.label}${field.required ? ' <span class="required">*</span>' : ''}`;
      
      let input;
      
      if (field.type === 'select' && field.options) {
        input = document.createElement('select');
        input.className = 'form-select';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select...';
        input.appendChild(defaultOption);
        
        field.options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          input.appendChild(option);
        });
      } else if (field.type === 'textarea') {
        input = document.createElement('textarea');
        input.className = 'form-textarea';
        input.rows = field.rows || 4;
      } else {
        input = document.createElement('input');
        input.className = 'form-input';
        input.type = field.type || 'text';
        
        if (field.placeholder) {
          input.placeholder = field.placeholder;
        }
      }
      
      input.id = `custom-${field.name}`;
      input.name = `custom-${field.name}`;
      input.required = field.required || false;
      
      fieldGroup.appendChild(label);
      fieldGroup.appendChild(input);
      customFieldsContainer.appendChild(fieldGroup);
    });
  }
  
  // Show error message
  function showError(message) {
    loadingMessage.style.display = 'none';
    contactForm.style.display = 'none';
    errorText.textContent = message;
    errorMessage.style.display = 'block';
  }
  
  // Show form message (success/error)
  function showFormMessage(message, isSuccess) {
    formMessage.textContent = message;
    formMessage.style.display = 'block';
    formMessage.className = 'form-message ' + (isSuccess ? 'success' : 'error');
    
    // Scroll to message
    formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  
  // Handle form submission
  async function handleSubmit(e) {
    e.preventDefault();
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Verifying...';
    formMessage.style.display = 'none';
    
    try {
      // Get reCAPTCHA token
      const recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, {action: 'submit'});
      
      // Update button text
      submitBtn.textContent = 'Sending...';
      
      // Gather form data
      const formData = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        category: document.getElementById('category').value,
        message: document.getElementById('message').value.trim(),
        newsletter: document.getElementById('newsletter').checked,
        recaptchaToken: recaptchaToken,
        customFields: {}
      };
      
      // Gather custom fields
      const customFieldInputs = customFieldsContainer.querySelectorAll('input, select, textarea');
      customFieldInputs.forEach(input => {
        const fieldName = input.name.replace('custom-', '');
        formData.customFields[fieldName] = input.value;
      });
      
      const response = await fetch(`${API_BASE_URL}/api/contact`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        showFormMessage(
          result.message || 'Thank you for your message! We will respond as soon as possible.',
          true
        );
        
        // Reset form
        contactForm.reset();
        customFieldsContainer.innerHTML = '';
        categoryDescription.textContent = '';
        
        // Show warnings if any
        if (result.warnings && result.warnings.length > 0) {
          console.warn('Form submission warnings:', result.warnings);
        }
        
      } else {
        showFormMessage(
          result.error || 'Failed to send message. Please try again or email us directly at doug@waccamaw.org',
          false
        );
        
        // Show validation errors if any
        if (result.errors && result.errors.length > 0) {
          const errorList = result.errors.join(', ');
          showFormMessage(`Validation errors: ${errorList}`, false);
        }
      }
      
    } catch (error) {
      console.error('Form submission error:', error);
      
      // Check if it's a reCAPTCHA error
      if (error.message && error.message.includes('grecaptcha')) {
        showFormMessage(
          'Unable to verify you are human. Please refresh the page and try again.',
          false
        );
      } else {
        showFormMessage(
          'Unable to send message due to a network error. Please try again later or email us directly at doug@waccamaw.org',
          false
        );
      }
    } finally {
      // Re-enable submit button and restore original HTML
      submitBtn.disabled = false;
      if (originalButtonHTML) {
        submitBtn.innerHTML = originalButtonHTML;
      } else {
        // Fallback if original HTML wasn't captured
        submitBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"></path></svg> Send Message';
      }
    }
  }
  
  // Attach form submit handler
  contactForm.addEventListener('submit', handleSubmit);
  
  // Initialize
  loadFormConfig();
})();
</script>

<style>
/* Contact Form Styles - Matches 404 page design */
.contact-container {
  max-width: var(--max-width, 900px);
  margin: 0 auto;
  padding: 2rem 1.5rem 4rem;
  min-height: 60vh;
}

.contact-content {
  background: var(--bg-white, #ffffff);
  border-radius: 12px;
  padding: 3rem 2.5rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.contact-header {
  text-align: center;
  margin-bottom: 2.5rem;
  padding-bottom: 2rem;
  border-bottom: 2px solid var(--bg-secondary, #fff5eb);
}

.contact-title {
  color: var(--primary-color, #0033cc);
  font-size: 2.5rem;
  margin-bottom: 1rem;
  font-weight: 700;
}

.contact-intro {
  color: var(--text-light, #6b6b6b);
  font-size: 1.1rem;
  line-height: 1.6;
  max-width: 700px;
  margin: 0 auto;
}

.contact-intro p {
  margin-bottom: 0.75rem;
}

.loading-message {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-light, #6b6b6b);
}

.loading-spinner {
  width: 40px;
  height: 40px;
  margin: 0 auto 1rem;
  border: 4px solid var(--bg-secondary, #fff5eb);
  border-top-color: var(--primary-color, #0033cc);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-notice {
  background: linear-gradient(135deg, #fee 0%, #fdd 100%);
  border-left: 5px solid #c33;
  border-radius: 8px;
  padding: 1.75rem;
  margin-bottom: 2rem;
  display: flex;
  gap: 1.25rem;
  align-items: start;
}

.notice-icon {
  font-size: 2rem;
  flex-shrink: 0;
  line-height: 1;
}

.notice-content {
  flex: 1;
  color: var(--text-color, #2a2a2a);
  line-height: 1.6;
}

.contact-form {
  max-width: 700px;
  margin: 0 auto;
}

.form-group {
  margin-bottom: 1.75rem;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text-color, #2a2a2a);
  font-size: 1rem;
}

.required {
  color: #c33;
  font-weight: bold;
}

.form-input,
.form-select,
.form-textarea {
  width: 100%;
  padding: 0.875rem 1.25rem;
  border: 2px solid var(--border-color, #e0e0e0);
  border-radius: 8px;
  font-size: 1rem;
  font-family: inherit;
  transition: all 0.2s;
  background: var(--bg-white, #ffffff);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--primary-color, #0033cc);
  box-shadow: 0 0 0 3px rgba(0, 51, 204, 0.1);
}

.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%232a2a2a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  padding-right: 3rem;
}

.form-textarea {
  resize: vertical;
  min-height: 140px;
  line-height: 1.6;
}

.form-help {
  display: block;
  margin-top: 0.5rem;
  color: var(--text-light, #6b6b6b);
  font-size: 0.9rem;
  line-height: 1.5;
}

.checkbox-group {
  margin: 2rem 0;
}

.checkbox-label {
  display: flex;
  align-items: start;
  cursor: pointer;
  gap: 0.75rem;
  color: var(--text-color, #2a2a2a);
  line-height: 1.6;
}

.form-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  margin-top: 2px;
  flex-shrink: 0;
  accent-color: var(--primary-color, #0033cc);
}

.recaptcha-notice {
  margin: 1.5rem 0;
  padding: 1rem;
  background: var(--bg-secondary, #fff5eb);
  border-radius: 6px;
  font-size: 0.85rem;
  color: var(--text-light, #6b6b6b);
  line-height: 1.5;
  text-align: center;
}

.recaptcha-notice p {
  margin: 0;
}

.recaptcha-notice a {
  color: var(--primary-color, #0033cc);
  text-decoration: none;
  font-weight: 500;
}

.recaptcha-notice a:hover {
  text-decoration: underline;
}

.submit-button {
  width: 100%;
  padding: 1rem 2rem;
  background: var(--primary-color, #0033cc);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  font-family: inherit;
}

.submit-button:hover:not(:disabled) {
  background: var(--primary-hover, #0028a3);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 51, 204, 0.3);
}

.submit-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.submit-button svg {
  width: 20px;
  height: 20px;
}

.form-message {
  margin-top: 1.5rem;
  padding: 1.25rem 1.5rem;
  border-radius: 8px;
  border-left: 4px solid;
  font-size: 1rem;
  line-height: 1.6;
}

.form-message.success {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  border-left-color: #28a745;
  color: #155724;
}

.form-message.error {
  background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
  border-left-color: #dc3545;
  color: #721c24;
}

.contact-info-box {
  margin-top: 3rem;
  padding: 2rem;
  background: var(--bg-color, #faf8f3);
  border-radius: 8px;
  border-left: 4px solid var(--primary-color, #0033cc);
}

.contact-info-box h3 {
  margin: 0 0 1.25rem 0;
  color: var(--text-color, #2a2a2a);
  font-size: 1.3rem;
  font-weight: 600;
}

.contact-methods {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.contact-method {
  color: var(--text-color, #2a2a2a);
  line-height: 1.6;
}

.contact-method strong {
  display: inline-block;
  min-width: 120px;
}

.contact-method a {
  color: var(--link-color, #0033cc);
  text-decoration: none;
  font-weight: 500;
}

.contact-method a:hover {
  text-decoration: underline;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .contact-content {
    padding: 2rem 1.5rem;
  }

  .contact-title {
    font-size: 2rem;
  }

  .contact-intro {
    font-size: 1rem;
  }

  .form-label {
    font-size: 0.95rem;
  }

  .submit-button {
    font-size: 1rem;
  }
}

@media (max-width: 480px) {
  .contact-container {
    padding: 1rem;
  }

  .contact-content {
    padding: 1.5rem 1rem;
  }

  .contact-title {
    font-size: 1.75rem;
  }

  .error-notice,
  .contact-info-box {
    padding: 1.25rem;
  }

  .contact-method strong {
    display: block;
    margin-bottom: 0.25rem;
  }
  
  .recaptcha-notice {
    font-size: 0.8rem;
    padding: 0.75rem;
  }
}

/* Hide reCAPTCHA badge since we show notice explicitly */
.grecaptcha-badge {
  visibility: hidden;
}
</style>
{{ end }}
