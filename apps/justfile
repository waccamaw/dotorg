# Apps Management - Justfile
# Run commands across all microservices in apps/

# Default recipe to display help
default:
    @just --list

# List all service directories
_services:
    #!/usr/bin/env bash
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            echo "${dir%/}"
        fi
    done

# Install dependencies for all services
deps:
    #!/usr/bin/env bash
    echo "ðŸ“¦ Installing dependencies for all services..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            echo ""
            echo "ðŸ”§ Setting up $service..."
            cd "$dir"
            if just deps 2>/dev/null || just install 2>/dev/null; then
                echo "âœ… $service dependencies installed"
            else
                echo "âš ï¸  No deps/install command for $service"
            fi
            cd ..
        fi
    done
    echo ""
    echo "âœ… All services ready!"

# Start all services in background
dev-bg:
    #!/usr/bin/env bash
    echo "ðŸš€ Starting all services in background..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            echo ""
            echo "ðŸš€ Starting $service..."
            cd "$dir"
            if just dev-bg 2>/dev/null; then
                echo "âœ… $service started"
            else
                echo "âš ï¸  No dev-bg command for $service"
            fi
            cd ..
        fi
    done
    echo ""
    echo "âœ… All services running!"
    echo ""
    echo "ðŸ“‹ Service URLs:"
    echo "   â€¢ member-services: http://localhost:8787"
    echo "   â€¢ contact-service: http://localhost:8788"
    echo "   â€¢ meetings-service: http://localhost:8789"
    echo ""
    echo "ðŸ›‘ Stop all: just dev-stop"
    echo "ðŸ“Š Status: just status"

# Stop all background services
dev-stop:
    #!/usr/bin/env bash
    echo "ðŸ›‘ Stopping all services..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            cd "$dir"
            if just dev-stop 2>/dev/null; then
                echo "âœ… $service stopped"
            fi
            cd ..
        fi
    done
    echo ""
    echo "âœ… All services stopped"

# Show status of all services
status:
    #!/usr/bin/env bash
    echo "ðŸ“Š Service Status:"
    echo ""
    
    # Check member-services (port 8787)
    if curl -s -m 2 http://localhost:8787/ > /dev/null 2>&1; then
        echo "âœ… member-services (http://localhost:8787) - Running"
    else
        echo "âŒ member-services (http://localhost:8787) - Not running"
    fi
    
    # Check contact-service (port 8788)
    if curl -s -m 2 http://localhost:8788/ > /dev/null 2>&1; then
        echo "âœ… contact-service (http://localhost:8788) - Running"
    else
        echo "âŒ contact-service (http://localhost:8788) - Not running"
    fi
    
    # Check meetings-service (port 8789)
    if curl -s -m 2 http://localhost:8789/ > /dev/null 2>&1; then
        echo "âœ… meetings-service (http://localhost:8789) - Running"
    else
        echo "âŒ meetings-service (http://localhost:8789) - Not running"
    fi

# Run a command in all services
run COMMAND:
    #!/usr/bin/env bash
    echo "ðŸ”„ Running '{{COMMAND}}' in all services..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            echo ""
            echo "ðŸ“ $service:"
            cd "$dir"
            just {{COMMAND}} || echo "âš ï¸  Command not available in $service"
            cd ..
        fi
    done

# Clean all services
clean:
    #!/usr/bin/env bash
    echo "ðŸ§¹ Cleaning all services..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            cd "$dir"
            if just clean 2>/dev/null; then
                echo "âœ… $service cleaned"
            fi
            cd ..
        fi
    done
    echo "âœ… All services cleaned"

# Show logs for all services
logs:
    #!/usr/bin/env bash
    echo "ðŸ“‹ Recent logs from all services:"
    for dir in */; do
        if [ -f "${dir}.wrangler/dev.log" ]; then
            service="${dir%/}"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ“ $service"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            tail -n 20 "${dir}.wrangler/dev.log"
        fi
    done

# Follow logs for a specific service
logs-follow SERVICE:
    tail -f {{SERVICE}}/.wrangler/dev.log

# Test health endpoints for all services
test-health:
    #!/usr/bin/env bash
    echo "ðŸ§ª Testing health endpoints..."
    echo ""
    
    # Test member-services
    echo "ðŸ“ member-services:"
    curl -s http://localhost:8787/ | jq . || echo "âŒ Failed"
    echo ""
    
    # Test contact-service
    echo "ðŸ“ contact-service:"
    curl -s http://localhost:8788/ | jq . || echo "âŒ Failed"
    echo ""
    
    # Test meetings-service
    echo "ðŸ“ meetings-service:"
    curl -s http://localhost:8789/ | jq . || echo "âŒ Failed"
    echo ""

# Deploy all services to production
deploy-all:
    #!/usr/bin/env bash
    echo "ðŸš€ Deploying all services to production..."
    read -p "Are you sure? This will deploy ALL services to production. (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        for dir in */; do
            if [ -f "${dir}justfile" ]; then
                service="${dir%/}"
                echo ""
                echo "ðŸš€ Deploying $service..."
                cd "$dir"
                just deploy || echo "âš ï¸  Deploy failed for $service"
                cd ..
            fi
        done
        echo ""
        echo "âœ… All services deployed!"
    else
        echo "âŒ Deployment cancelled"
    fi

# Show info for all services
info:
    #!/usr/bin/env bash
    echo "ðŸ“‹ Apps Directory Services"
    echo "=========================="
    echo ""
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            echo "ðŸ“¦ $service"
            if [ -f "${dir}package.json" ]; then
                version=$(node -p "require('./${dir}package.json').version" 2>/dev/null)
                desc=$(node -p "require('./${dir}package.json').description" 2>/dev/null)
                echo "   Version: $version"
                echo "   Description: $desc"
            fi
            echo ""
        fi
    done
