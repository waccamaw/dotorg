# Apps Management - Justfile
# Run commands across all microservices in apps/

# Default recipe to display help
default:
    @just --list

# Sync email templates from Hugo static directory to members-service
sync-email-templates:
    #!/usr/bin/env bash
    set -e
    echo "ðŸ“§ Syncing email templates..."
    echo ""
    
    # Source and destination paths
    SRC="../static/members/email-templates"
    DEST="members-service/src/templates"
    
    # Copy HTML and TXT templates
    cp "$SRC"/reminder-*.html "$DEST/"
    cp "$SRC"/reminder-*.txt "$DEST/" 2>/dev/null || echo "âš ï¸  No .txt files found (OK if not using plain text)"
    
    # Count synced files
    HTML_COUNT=$(ls "$DEST"/reminder-*.html 2>/dev/null | wc -l)
    TXT_COUNT=$(ls "$DEST"/reminder-*.txt 2>/dev/null | wc -l)
    
    echo "âœ… Synced $HTML_COUNT HTML template(s) and $TXT_COUNT TXT template(s)"
    echo "   Source: static/members/email-templates/"
    echo "   Destination: apps/members-service/src/templates/"
    echo ""
    echo "ðŸ“‹ Preview URLs (direct access - no login required):"
    echo "   â€¢ http://localhost:1313/members/email-templates/reminder-inactive.html"
    echo "   â€¢ http://localhost:1313/members/email-templates/reminder-at-risk-critical.html"
    echo "   â€¢ http://localhost:1313/members/email-templates/reminder-at-risk-warning.html"
    echo ""
    echo "ðŸ” Dashboard Preview (requires executive login):"
    echo "   â€¢ http://localhost:1313/members/"
    echo ""
    echo "âš ï¸  Note: Changes must be committed and deployed to go live in production!"
    echo ""

# Watch email templates and auto-sync on changes
watch-email-templates:
    #!/usr/bin/env bash
    echo "ðŸ‘€ Watching static/members/email-templates/ for changes..."
    echo "   Press Ctrl+C to stop"
    echo ""
    
    # Use fswatch if available, otherwise fall back to polling
    if command -v fswatch >/dev/null 2>&1; then
        fswatch -o ../static/members/email-templates/reminder-*.{html,txt} | while read; do
            just sync-email-templates
        done
    elif command -v inotifywait >/dev/null 2>&1; then
        while inotifywait -e modify,create ../static/members/email-templates/reminder-*.{html,txt}; do
            just sync-email-templates
        done
    else
        # Fallback: polling every 2 seconds
        echo "âš ï¸  No file watcher found (fswatch/inotifywait), using polling..."
        LAST_HASH=""
        while true; do
            CURRENT_HASH=$(find ../static/members/email-templates/reminder-*.{html,txt} -type f -exec md5sum {} \; 2>/dev/null | md5sum)
            if [ "$CURRENT_HASH" != "$LAST_HASH" ] && [ -n "$LAST_HASH" ]; then
                echo "\nðŸ”„ Change detected!"
                just sync-email-templates
            fi
            LAST_HASH="$CURRENT_HASH"
            sleep 2
        done
    fi

# List all service directories
_services:
    #!/usr/bin/env bash
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            echo "${dir%/}"
        fi
    done

# Install dependencies for all services
deps:
    #!/usr/bin/env bash
    echo "ðŸ“¦ Installing dependencies for all services..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            echo ""
            echo "ðŸ”§ Setting up $service..."
            cd "$dir"
            if just deps 2>/dev/null || just install 2>/dev/null; then
                echo "âœ… $service dependencies installed"
            else
                echo "âš ï¸  No deps/install command for $service"
            fi
            cd ..
        fi
    done
    echo ""
    echo "âœ… All services ready!"

# Sync content to local KV for all services (runs during devcontainer startup)
sync-local:
    #!/usr/bin/env bash
    echo "ðŸ”„ Syncing content to local KV for all services..."
    echo ""
    
    # Sync meetings-service
    if [ -d "meetings-service" ]; then
        echo "ðŸ“ meetings-service:"
        cd meetings-service
        if just sync-local 2>/dev/null; then
            echo "âœ… Meetings content synced to local KV"
        else
            echo "âš ï¸  Sync failed for meetings-service"
        fi
        cd ..
        echo ""
    fi
    
    # Add other services here as they implement local KV sync
    # if [ -d "contact-service" ]; then
    #     echo "ðŸ“ contact-service:"
    #     cd contact-service
    #     just sync-local 2>/dev/null
    #     cd ..
    #     echo ""
    # fi
    
    echo "âœ… Local KV sync complete!"


# Start all services in background
dev-bg:
    #!/usr/bin/env bash
    echo "ðŸš€ Starting all services in background..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            echo ""
            echo "ðŸš€ Starting $service..."
            cd "$dir"
            if just dev-bg 2>/dev/null; then
                echo "âœ… $service started"
            else
                echo "âš ï¸  No dev-bg command for $service"
            fi
            cd ..
        fi
    done
    echo ""
    echo "âœ… All services running!"
    echo ""
    echo "ðŸ“‹ Service URLs:"
    echo "   â€¢ member-services: http://localhost:8787"
    echo "   â€¢ contact-service: http://localhost:8788"
    echo "   â€¢ meetings-service: http://localhost:8789"
    echo ""
    echo "ðŸ›‘ Stop all: just dev-stop"
    echo "ðŸ“Š Status: just status"

# Stop all background services
dev-stop:
    #!/usr/bin/env bash
    echo "ðŸ›‘ Stopping all services..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            cd "$dir"
            if just dev-stop 2>/dev/null; then
                echo "âœ… $service stopped"
            fi
            cd ..
        fi
    done
    echo ""
    echo "âœ… All services stopped"

# Show status of all services
status:
    #!/usr/bin/env bash
    echo "ðŸ“Š Service Status:"
    echo ""
    
    # Check members-service (port 8787)
    if curl -s -m 2 http://localhost:8787/ > /dev/null 2>&1; then
        echo "âœ… members-service (http://localhost:8787) - Running"
    else
        echo "âŒ members-service (http://localhost:8787) - Not running"
    fi
    
    # Check contact-service (port 8788)
    if curl -s -m 2 http://localhost:8788/ > /dev/null 2>&1; then
        echo "âœ… contact-service (http://localhost:8788) - Running"
    else
        echo "âŒ contact-service (http://localhost:8788) - Not running"
    fi
    
    # Check meetings-service (port 8789)
    if curl -s -m 2 http://localhost:8789/ > /dev/null 2>&1; then
        echo "âœ… meetings-service (http://localhost:8789) - Running"
    else
        echo "âŒ meetings-service (http://localhost:8789) - Not running"
    fi

# Run a command in all services
run COMMAND:
    #!/usr/bin/env bash
    echo "ðŸ”„ Running '{{COMMAND}}' in all services..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            echo ""
            echo "ðŸ“ $service:"
            cd "$dir"
            just {{COMMAND}} || echo "âš ï¸  Command not available in $service"
            cd ..
        fi
    done

# Clean all services
clean:
    #!/usr/bin/env bash
    echo "ðŸ§¹ Cleaning all services..."
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            cd "$dir"
            if just clean 2>/dev/null; then
                echo "âœ… $service cleaned"
            fi
            cd ..
        fi
    done
    echo "âœ… All services cleaned"

# Show logs for all services
logs:
    #!/usr/bin/env bash
    echo "ðŸ“‹ Recent logs from all services:"
    for dir in */; do
        if [ -f "${dir}.wrangler/dev.log" ]; then
            service="${dir%/}"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ“ $service"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            tail -n 20 "${dir}.wrangler/dev.log"
        fi
    done

# Follow logs for a specific service
logs-follow SERVICE:
    tail -f {{SERVICE}}/.wrangler/dev.log

# Test health endpoints for all services
test-health:
    #!/usr/bin/env bash
    echo "ðŸ§ª Testing health endpoints..."
    echo ""
    
    # Test members-service
    echo "ðŸ“ members-service:"
    curl -s http://localhost:8787/ | jq . || echo "âŒ Failed"
    echo ""
    
    # Test contact-service
    echo "ðŸ“ contact-service:"
    curl -s http://localhost:8788/ | jq . || echo "âŒ Failed"
    echo ""
    
    # Test meetings-service
    echo "ðŸ“ meetings-service:"
    curl -s http://localhost:8789/ | jq . || echo "âŒ Failed"
    echo ""

# Deploy all services to production
deploy-all:
    #!/usr/bin/env bash
    echo "ðŸš€ Deploying all services to production..."
    read -p "Are you sure? This will deploy ALL services to production. (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        for dir in */; do
            if [ -f "${dir}justfile" ]; then
                service="${dir%/}"
                echo ""
                echo "ðŸš€ Deploying $service..."
                cd "$dir"
                just deploy || echo "âš ï¸  Deploy failed for $service"
                cd ..
            fi
        done
        echo ""
        echo "âœ… All services deployed!"
    else
        echo "âŒ Deployment cancelled"
    fi

# Show info for all services
info:
    #!/usr/bin/env bash
    echo "ðŸ“‹ Apps Directory Services"
    echo "=========================="
    echo ""
    for dir in */; do
        if [ -f "${dir}justfile" ]; then
            service="${dir%/}"
            echo "ðŸ“¦ $service"
            if [ -f "${dir}package.json" ]; then
                version=$(node -p "require('./${dir}package.json').version" 2>/dev/null)
                desc=$(node -p "require('./${dir}package.json').description" 2>/dev/null)
                echo "   Version: $version"
                echo "   Description: $desc"
            fi
            echo ""
        fi
    done
